<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>å¡¾ãƒãƒ ç†Ÿèª 1357</title>

  <style>
    :root{
      --bd: #ddd;
      --bd-dark: #2a2f3a;
      --bg: #fff;
      --fg: #111;
      --muted: #666;
      --card: #fff;
      --card-dark: #171a21;

      --pill-pad-y: 10px;
      --pill-pad-x: 12px;
      --pill-radius: 999px;

      --btn-radius: 12px;

      /* å¾©ç¿’ç³»ã®æ·¡ã„è‰²ï¼ˆçµ±ä¸€ï¼‰ */
      --review-bg: #f3f6fb;
      --review-bd: #cfd8e3;
      --review-fg: #334155;

      --review-bg-hover: #e9eef7;
      --review-accent: #64748b;

      /* wheel */
      --wheel-item-h: 44px;
      --wheel-fade: rgba(255,255,255,0.9);
      --wheel-fade-dark: rgba(15,17,21,0.85);
    }

    body{
      font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
      margin: 0;
      padding: 5px;
      background: var(--bg);
      color: var(--fg);
      transition: background .2s ease, color .2s ease;
    }

    .card{
      max-width: 820px;
      margin: 0 auto;
      padding: 18px;
      border: 1px solid var(--bd);
      border-radius: 14px;
      background: var(--card);
      transition: background .2s ease, border-color .2s ease;
      position: relative;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 10px;
    }

    /* âœ… å¾©ç¿’è¡Œï¼šå·¦(å¾©ç¿’) / å³(ãƒœã‚¿ãƒ³ç¾¤) */
    .reviewRow{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:nowrap;
    }
    .reviewRow-right{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:10px;
    }
    @media (max-width: 360px){
      .reviewRow{ flex-wrap:wrap; }
      .reviewRow-right{
        width:100%;
        justify-content:flex-end;
        margin-left:0;
      }
    }

    .badge,
    button.small,
    .pill{
      font-size: 16px;
      line-height: 1;
      padding: var(--pill-pad-y) var(--pill-pad-x);
      border-radius: var(--pill-radius);
      border: 1px solid var(--bd);
      background: transparent;
      color: inherit;
      transition: background .2s ease, border-color .2s ease, color .2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      user-select: none;
      white-space: nowrap;

      /* âœ… ç¸¦ã®éš™é–“ã‚’è©°ã‚ã‚‹ */
      padding-top: 6px;
      padding-bottom: 6px;
      padding-left: 8px;
      padding-right: 8px;   /* â† ã“ã“ã‚’å°ã•ã */
    }

    .pill{ cursor: pointer; }
    button.small{ cursor: pointer; }
    button.small:active{ transform: translateY(1px); }

    .btns{
      display:flex;
      gap:10px;
      margin-top: 16px;
      flex-wrap:wrap;
      align-items:center;
    }

    button{
      font-size: 16px;
      padding: 10px 14px;
      border-radius: var(--btn-radius);
      border: 1px solid var(--bd);
      background: #fff;
      color: #111;
      cursor: pointer;
      transition: background .2s ease, border-color .2s ease, color .2s ease;
    }
    button:active{ transform: translateY(1px); }

    button.small.toggle{ font-size: 18px; }

    #speakBtn{
      margin-left: auto;
      margin-right: 4px;
    }

    .primary{ font-weight: 500; }
    .danger{ border-color:#f2c; }
    .toggle{ border-color:#88c; }
    .pill.togglePill{ border-color:#88c; }

    .pill input[type="checkbox"]{
      width:18px;
      height:18px;
      margin:0;
      accent-color: #88c;
      transform: translateY(0.5px);
    }
    .pill .count{
      opacity: .85;
      font-variant-numeric: tabular-nums;
    }

    .reviewUI{
      background: var(--review-bg);
      border-color: var(--review-bd);
      color: var(--review-fg);
      border-radius: 14px;
    }
    @media (hover: hover) and (pointer: fine){
      .reviewUI:hover{ background: var(--review-bg-hover); }
    }
    @media (hover: none){
      .reviewUI:hover{ background: var(--review-bg); }
    }

    .pressWhite:active{
      background: #fff;
      border-color: var(--review-bd);
      color: var(--review-fg);
    }
    @media (hover: none){
      .pressWhite:hover{ background: var(--review-bg); }
    }

    button, label, .pill{
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    .reviewUI input[type="checkbox"]{ accent-color: var(--review-accent); }

    .topbar{
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .topbar-right{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    .rangeInput{
      width: 3.5em;
      padding: 6px 6px;
      border: 1px solid var(--bd);
      border-radius: 10px;
      font-size: 14px;
      background: transparent;
      color: inherit;
      text-align: left;
    }

    /* âœ… ç¯„å›²å…¥åŠ›ï¼ˆNo ã€œï¼‰ã®ä¸Šä¸‹ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆã‚¹ãƒ”ãƒŠãƒ¼ï¼‰ã‚’æ¶ˆã™ */
    .rangeInput::-webkit-outer-spin-button,
    .rangeInput::-webkit-inner-spin-button{
      -webkit-appearance: none;
      margin: 0;
    }
    .rangeInput[type="number"]{
      appearance: textfield;
    }


    .word-no{
      font-size: 14px;
      font-weight: 600;
      color: var(--muted);
      line-height: 1;
      user-select: none;
    }

    .word-num-header{
      font-size: 14px;
      font-weight: 600;
      color: var(--muted);
      margin-left: 1px;
      line-height: 1;
      user-select: none;
    }

    .displayArea{ min-height: 155px; }

    .word{
      margin: 18px 0 10px;
      line-height: 1.1;
      word-break: break-word;
    }
    .word-text{
      font-size: 30px;
      font-weight: 400;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    .meaning{
      font-size: 18px;
      margin: 10px 0 0;
      min-height: 40px;
      word-break: break-word;
      overflow-wrap: anywhere;
    }

    .missBox{
      display:none;
      margin-top: 12px;
      padding: 6px;
      border: 1px solid var(--bd);
      border-radius: 12px;
      gap: 10px;
      align-items: center;
      flex-wrap: nowrap;
      width: fit-content;
      max-width: 100%;
      flex: 0 0 auto;
      align-self: flex-start;
      background: rgba(0,0,0,0.02);
    }
    .missBox.show{ display:inline-flex; }
    .missBox input{ width: 22px; height: 22px; margin:0; }
    .missBox .label{ font-size: 14px; user-select: none; white-space: nowrap; display: inline-block;}

    /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
    body.dark{
      background: #0f1115;
      color: #e9e9ea;
    }
    body.dark .card{
      background: var(--card-dark);
      border-color: var(--bd-dark);
    }
    body.dark .badge,
    body.dark button.small,
    body.dark .pill{
      border-color: var(--bd-dark);
      background: rgba(255,255,255,0.03);
      color: #d6d6d8;
    }
    body.dark button{
      background: #1f2430;
      border-color: var(--bd-dark);
      color: #e9e9ea;
    }
    body.dark .missBox{
      border-color: var(--bd-dark);
      background: rgba(255,255,255,0.03);
    }
    body.dark .rangeInput{ border-color: var(--bd-dark); }
    body.dark .word-num-header{ color:#aaa; }

    body.dark .reviewUI{
      background: rgba(255,255,255,0.06);
      border-color: var(--bd-dark);
      color: #e5e7eb;
    }

    body.dark .pressWhite:active{
      background: rgba(255,255,255,0.16);
      border-color: var(--bd-dark);
      color: #e5e7eb;
    }

    .page-title{
      font-size: 16px;
      font-weight: 700;
      margin: 0 0 12px;
      text-align: center;
      letter-spacing: 0.03em;
    }
    body.dark .page-title{ color: #e9e9ea; }

    /* =========================
       âœ… ç™ºéŸ³é€Ÿåº¦UI
    ========================= */
    .speedBox{
      flex: 0 0 auto;
      display:flex;
      align-items:center;
      gap:4px;
      padding: 8px 8px;
      border: 1px solid var(--bd);
      border-radius: 999px;
      background: transparent;
      user-select:none;
      min-width: 20px;
    }
    body.dark .speedBox{
      border-color: var(--bd-dark);
      background: rgba(255,255,255,0.03);
      color: #d6d6d8;
    }
    .speedBox input[type="range"]{
      width: 60px;
      display: block;
      margin: 0;
    }
    .speedBox .val{
      font-size: 13px;
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
      opacity: .9;
      min-width: 2.0em;
      text-align: right;
    }

    /* âœ… æ¢ã™è¡Œï¼š1è¡Œå›ºå®š */
    .searchRow{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap: nowrap;
    }
    .searchRow-right{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap: nowrap;
      min-width: 0;
    }
    .searchRow #speakBtn{
      margin-left: 0; /* ã“ã®è¡Œã ã‘ */
    }

    /* âœ… Autoè¡¨ç¤ºæ™‚é–“ï¼ˆæ¢ã™ã®ä¸‹æ®µï¼‰ */
    .autoTimeRow{
      margin-top: 8px;
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap: nowrap;          /* â† 1è¡Œå›ºå®š */
    }

    .autoTimeBadge{
      flex: 1 1 auto;
      min-width: 0;
      display:flex;
      align-items:center;
      gap:6px;
      flex-wrap: nowrap;          /* â† ä¸­ã‚‚1è¡Œå›ºå®š */
      overflow: hidden;           /* â† ã¯ã¿å‡ºã—é˜²æ­¢ */
    }

    .msInput{
      width: 2.5em;               /* â† 4æ¡åˆ† */
      padding: 4px 8px;
      border: 1px solid var(--bd);
      border-radius: 10px;
      font-size: 14px;            /* â† 14px */
      background: transparent;
      color: inherit;
    }

    /* âœ… numberå…¥åŠ›ã®ä¸Šä¸‹ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆã‚¹ãƒ”ãƒŠãƒ¼ï¼‰ã‚’æ¶ˆã™ */
    .msInput::-webkit-outer-spin-button,
    .msInput::-webkit-inner-spin-button{
      -webkit-appearance: none;
      margin: 0;
    }
    .msInput[type="number"]{
      appearance: textfield;
    }


    body.dark .msInput{ border-color: var(--bd-dark); }

    .miniLbl{ font-size: 13px; opacity: .85; }
    .unit{ font-size: 12px; opacity: .75; }

    /* âœ… åˆæœŸå€¤ãƒœã‚¿ãƒ³ã‚’å°ã•ãï¼ˆbutton.small ã‚ˆã‚Šå¼·ãï¼‰ */
    button.small.miniBtn{
      font-size: 14px;   /* å¥½ã¿ã§ 10ã€œ13px */
      padding: 6px 8px;  /* å¥½ã¿ã§èª¿æ•´ */
      border-radius: 999px;
      line-height: 1;
      white-space: nowrap;
    }



    /* PC/iPadã§ã¯ã‚«ãƒ¼ãƒ‰ã‚’ç´°ãã—ã¦ç¸¦é•·ã«è¦‹ã›ã‚‹ */
    @media (min-width: 768px){
      .card{ max-width: 300px; }
    }

    #nextBtn{ width: 100%; }

    /* å¾©ç¿’ãƒªã‚¹ãƒˆã«è¿½åŠ ï¼ˆæ ï¼‰ã®ã‚µã‚¤ã‚ºèª¿æ•´ */
    #missBox{
      width: 100%;
      box-sizing: border-box;
      justify-content: center;
      align-self: stretch;
      flex: 1 1 auto;
      display: flex;
      cursor: pointer;
    }
    #missBox input{ cursor: pointer; }

    /* wheelï¼ˆè¦‹ãŸç›®ã¯ãã®ã¾ã¾ãƒ»çœç•¥ã›ãšæ®‹ã™ï¼‰ */
    .modalOverlay{ position: fixed; inset: 0; background: rgba(0,0,0,0.35); display: none; align-items: flex-end; justify-content: center; padding-left: 14px; padding-right: 14px; padding-top: calc(env(safe-area-inset-top) + 10px); padding-bottom: calc(env(safe-area-inset-bottom) + 14px); z-index: 9999; }
    .modalOverlay.show{ display:flex; }
    .modalSheet{ width: min(500px, 100%); border-radius: 18px; border: 1px solid var(--bd); background: #fff; color: #111; box-shadow: 0 12px 40px rgba(0,0,0,.18); overflow: hidden; transform: translateY(8px); animation: sheetIn .16s ease-out forwards; max-height: calc(100dvh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 20px); overflow: auto; -webkit-overflow-scrolling: touch; }
    @keyframes sheetIn{ to{ transform: translateY(0); } }
    body.dark .modalSheet{ background: #171a21; color: #e9e9ea; border-color: var(--bd-dark); box-shadow: 0 12px 40px rgba(0,0,0,.35); }
    .modalHeader{ display:flex; align-items:center; justify-content: space-between; padding: 6px 12px; border-bottom: 1px solid var(--bd); gap: 10px; }
    body.dark .modalHeader{ border-bottom-color: var(--bd-dark); }
    .modalTitle{ font-size: 14px; font-weight: 700; letter-spacing: .02em; opacity: .95; user-select: none; }
    .modalHeader .mini{ font-size: 14px; padding: 10px 12px; border-radius: 999px; border: 1px solid var(--bd); background: transparent; color: inherit; }
    body.dark .modalHeader .mini{ border-color: var(--bd-dark); background: rgba(255,255,255,0.03); }
    .wheelSearchRow{ display:flex; gap:8px; padding: 6px; border-bottom: 1px solid var(--bd); }
    body.dark .wheelSearchRow{ border-bottom-color: var(--bd-dark); }
    .wheelSearch{ flex: 1; border: 1px solid var(--bd); border-radius: 12px; padding: 10px 12px; font-size: 14px; background: transparent; color: inherit; outline: none; }
    body.dark .wheelSearch{ border-color: var(--bd-dark); }
    .wheelArea{ position: relative; padding: 12px 12px 2px; }
    .wheelViewport{ position: relative; height: calc(var(--wheel-item-h) * 7); overflow-y: auto; -webkit-overflow-scrolling: touch; scroll-snap-type: y mandatory; overscroll-behavior: contain; border-radius: 16px; border: 1px solid var(--bd); background: rgba(0,0,0,0.02); touch-action: pan-y; }
    body.dark .wheelViewport{ border-color: var(--bd-dark); background: rgba(255,255,255,0.03); }
    .wheelFadeTop, .wheelFadeBottom{ pointer-events: none; position: absolute; left: 12px; right: 12px; height: 44px; z-index: 2; }
    .wheelFadeTop{ top: 12px; background: linear-gradient(to bottom, var(--wheel-fade), rgba(255,255,255,0)); }
    .wheelFadeBottom{ bottom: 2px; background: linear-gradient(to top, var(--wheel-fade), rgba(255,255,255,0)); }
    body.dark .wheelFadeTop{ background: linear-gradient(to bottom, var(--wheel-fade-dark), rgba(15,17,21,0)); }
    body.dark .wheelFadeBottom{ background: linear-gradient(to top, var(--wheel-fade-dark), rgba(15,17,21,0)); }
    .wheelCenterLine{ pointer-events: none; position: absolute; left: 12px; right: 12px; top: calc(12px + (var(--wheel-item-h) * 3)); height: var(--wheel-item-h); border-top: 1px solid rgba(100,116,139,0.35); border-bottom: 1px solid rgba(100,116,139,0.35); border-radius: 14px; z-index: 3; display: none;}
    .wheelList{ position: relative; padding: calc(var(--wheel-item-h) * 3) 0; margin: 0; list-style: none; }
    .wheelItem{ height: var(--wheel-item-h); display:flex; align-items:center; justify-content: center; scroll-snap-align: center; user-select: none; padding: 0 14px; }
    .wheelItemInner{ width: 100%; max-width: 92%; text-align: left; padding: 8px 10px; border-radius: 14px; border: 1px solid transparent; line-height: 1.15; word-break: break-word; overflow-wrap: anywhere; display: grid; grid-template-columns: 3.2em 1fr; column-gap: 10px; align-items: center; }
    .wheelItemInner .num{ font-size: 12px; opacity: .70; font-variant-numeric: tabular-nums; justify-self: start; user-select: none; }
    .wheelItemInner .main{ font-size: 18px; font-weight: 500; }
    .wheelItemInner .ja{ display: block; font-size: 12px; opacity: .70; margin-top: 2px; line-height: 1.2; word-break: break-word; overflow-wrap: anywhere; }
    .wheelItem.isActive .wheelItemInner{ border-color: rgba(100,116,139,0.25); background: rgba(100,116,139,0.06); }
    .wheelFooter{ display:flex; gap:10px; padding: 8px; border-top: 1px solid var(--bd); justify-content: space-between; flex-wrap: wrap; align-items:center; }
    body.dark .wheelFooter{ border-top-color: var(--bd-dark); }
    .wheelHint{ font-size: 12px; opacity: .75; padding: 0 12px 10px; user-select: none; min-height: 1.2em; }
    .mini{ font-size: 14px; padding: 10px 30px; border-radius: 999px; border: 1px solid var(--bd); background: transparent; color: inherit; }
    body.dark .mini{ border-color: var(--bd-dark); background: rgba(255,255,255,0.03); }

    /* âœ… 1è¡Œç›®ï¼ˆ0/0 ã‚‚å«ã‚ã¦ï¼‰é«˜ã•ã‚’æƒãˆã‚‹ */
    .topbar .badge,
    .topbar-right button.small{
      padding-top: 12px;
      padding-bottom: 12px;
    }

    /* âœ… 2è¡Œç›®ï¼ˆå¾©ç¿’ãƒ»å³ãƒœã‚¿ãƒ³ç¾¤ï¼‰ã‚’åŒã˜é«˜ã•ã§å°‘ã—å¤§ãã */
    .reviewRow .pill,
    .reviewRow button.small{
      padding-top: 12px;
      padding-bottom: 12px;
    }

    #resetBtn, #clearWrongBtn { font-size: 16px; }

    /* âœ… æœ€ä¸‹è¡Œï¼ˆæ¢ã™ãƒ»ç™ºéŸ³ï¼‰ã ã‘æ–‡å­—ã‚’å°‘ã—å°ã•ã */
    .searchRow > button,
    .searchRow-right > button{
      font-size: 14px;
    }

    /* âœ… WakeLockçŠ¶æ…‹è¡¨ç¤ºï¼ˆå°ã•ãï¼‰ */
    .wakeBadge{
      position:absolute;
      right: 10px;
      bottom: 10px;
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--bd);
      background: rgba(255,255,255,0.75);
      color: inherit;
      user-select:none;
      display:none;
    }
    body.dark .wakeBadge{
      border-color: var(--bd-dark);
      background: rgba(0,0,0,0.25);
    }
    .wakeBadge.show{ display:inline-flex; gap:8px; align-items:center; }
    .wakeDot{
      width: 7px; height: 7px; border-radius: 999px;
      background: #999;
      display:inline-block;
    }
    .wakeDot.on{ background: #22c55e; }
    .wakeDot.off{ background: #ef4444; }

    /* âœ… ç¯„å›² + Auto ã‚’æ¨ªä¸¦ã³ã€ç¾åœ¨Noã‚’ä¸‹ã¸ï¼ˆgridç‰ˆï¼‰ */
    .rangeWrap{
      width: 100%;
      display: grid;
      grid-template-columns: 1fr auto;
      row-gap: 6px;
      column-gap: 10px;
    }

    /* âœ… rangeBadge ã‚’ grid ã®ä¼¸ã³ï¼ˆstretchï¼‰ã‹ã‚‰å¤–ã—ã¦ã€ä¸­èº«ã®å¹…ã«åˆã‚ã›ã‚‹ */
    .rangeBadge{
      justify-self: start;     /* â† ã“ã‚ŒãŒæœ¬å‘½ */
      width: fit-content;      /* â† å¿µã®ãŸã‚ï¼ˆiOSã§ã‚‚åŠ¹ãã‚„ã™ã„ï¼‰ */
    }


    .rangeTop{ grid-column: 1 / 3; display: contents; }
    .rangeBadge{ grid-column: 1; }
    #autoBtn{ grid-column: 2; white-space: nowrap; }
    .rangeNow{
      grid-column: 2;
      display:flex;
      align-items:center;
      gap:8px;
      padding-left: 2px;
    }
    @media (max-width: 360px){
      .rangeWrap{ grid-template-columns: 1fr; }
      #autoBtn, .rangeNow{ grid-column: 1; }
    }
  </style>
</head>

<body>
  <div class="card">
    <h1 id="pageTitle" class="page-title"></h1>

    <div class="topbar">
      <div class="badge" id="progress">0 / 0</div>
      <div class="topbar-right">
        <button id="resetBtn" class="small reviewUI" type="button">Reset</button>
        <button class="small reviewUI pressWhite" id="clearWrongBtn" type="button">å¾©ç¿’Reset</button>
      </div>
    </div>

    <div class="row reviewRow">
      <label class="pill togglePill reviewUI" for="wrongOnlyToggle">
        <input type="checkbox" id="wrongOnlyToggle" />
        å¾©ç¿’ <span class="count" id="wrongCount">(0)</span>
      </label>

      <div class="reviewRow-right">
        <button class="small toggle" id="audioToggle" type="button">ğŸ”Š</button>
        <button class="small toggle" id="themeToggle" type="button">ğŸŒ™</button>
        <button class="small toggle" id="orderToggle" type="button">ğŸ”€</button>
      </div>
    </div>

    <div class="row">
      <div class="rangeWrap">
        <!-- ä¸Šæ®µï¼šç¯„å›² + Auto -->
        <div class="rangeTop">
          <label class="badge rangeBadge">
            No
            <input id="rangeFrom" class="rangeInput" type="number" min="1">
            ã€œ
            <input id="rangeTo" class="rangeInput" type="number" min="1">
          </label>

          <button class="small toggle" id="autoBtn" type="button">â–¶ï¸ Auto</button>
        </div>

        <!-- ä¸‹æ®µï¼šç¾åœ¨ã®å˜èªNoï¼ˆAutoã®ä¸‹ã«æ¥ã‚‹ï¼‰ -->
        <div class="rangeNow">
          <span class="word-no">No</span>
          <span id="wordNumHeader" class="word-num-header"></span>
        </div>
      </div>
    </div>

    <div class="displayArea">
      <div class="word">
        <span class="word-text" id="wordText">ï¼ˆreadingâ€¦ï¼‰</span>
      </div>
      <div class="meaning" id="meaning"></div>
    </div>

    <div class="btns">
      <button class="primary" id="nextBtn" type="button">ã¯ã˜ã‚ã‚‹</button>
    </div>

    <label class="missBox reviewUI" id="missBox">
      <input type="checkbox" id="missToggle">
      <span class="label">å¾©ç¿’ãƒªã‚¹ãƒˆã«è¿½åŠ </span>
    </label>

    <div class="btns searchRow">
      <button id="wheelOpenBtn" type="button">ğŸ¡ æ¢ã™</button>

      <div class="searchRow-right">
        <div class="speedBox" title="ç™ºéŸ³é€Ÿåº¦ã‚’èª¿æ•´ã—ã¾ã™">
          <input id="rateRange" type="range" min="0.6" max="1.2" step="0.1" value="1.0" />
          <span id="rateLabel" class="val">1.0x</span>
        </div>

        <button id="speakBtn" type="button">ğŸ”Š ç™ºéŸ³</button>
      </div>
    </div>

    <!-- âœ… æ¢ã™ãƒœã‚¿ãƒ³ã®ä¸‹æ®µï¼štimeï¼ˆ1è¡Œã«åã‚ã‚‹ï¼‰ -->
    <div class="row autoTimeRow">
      <div class="badge autoTimeBadge">
        â–¶ï¸ms:
        <span class="miniLbl">è‹±</span>
        <input id="autoEnMs" class="msInput" type="number" min="200" max="9999" step="100">
        <!-- <span class="unit">ms</span> -->
        <span class="unit">:</span>
        <span class="miniLbl">æ—¥</span>
        <input id="autoJaMs" class="msInput" type="number" min="200" max="9999" step="100">
        <!-- <span class="unit">ms</span> -->
      </div>

      <button class="small miniBtn reviewUI pressWhite" id="autoTimeResetBtn" type="button">åˆæœŸå€¤</button>
    </div>


    <!-- âœ… WakeLockã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
    <div class="wakeBadge" id="wakeBadge" title="Autoä¸­ã¯ã‚¹ãƒªãƒ¼ãƒ—ã—ã«ããã—ã¾ã™ï¼ˆå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã®ã¿ï¼‰">
      <span class="wakeDot off" id="wakeDot"></span>
      <span id="wakeText">Wake: OFF</span>
    </div>
  </div>

  <!-- ğŸ¡ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modalOverlay" id="wheelOverlay" aria-hidden="true">
    <div class="modalSheet" role="dialog" aria-modal="true" aria-labelledby="wheelTitle">
      <div class="modalHeader">
        <div class="modalTitle" id="wheelTitle">ğŸ¡ å˜èªæ¤œç´¢ï¼ˆè‹±oræ—¥ï¼‰</div>
        <button class="mini" id="wheelCloseBtn" type="button">é–‰ã˜ã‚‹</button>
      </div>

      <div class="wheelSearchRow">
        <input class="wheelSearch" id="wheelSearchInput" type="search" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢" autocomplete="off" />
        <button class="mini" id="wheelClearSearchBtn" type="button">ã‚¯ãƒªã‚¢</button>
      </div>

      <div class="wheelArea">
        <div class="wheelFadeTop"></div>
        <div class="wheelFadeBottom"></div>
        <div class="wheelCenterLine"></div>

        <div class="wheelViewport" id="wheelViewport">
          <ul class="wheelList" id="wheelList"></ul>
        </div>
      </div>

      <div class="wheelHint" id="wheelHint"></div>

      <div class="wheelFooter">
        <button class="mini" id="wheelMoreBtn" type="button">ã•ã‚‰ã«è¡¨ç¤º</button>

        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; margin-left:auto;">
          <button class="mini" id="wheelJumpBtn" type="button">ã“ã®å˜èªã¸ç§»å‹•</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   âœ… VOCABï¼ˆã‚ãªãŸã®ãƒ‡ãƒ¼ã‚¿ã«ç½®æ›ï¼‰
========================= */
const VOCAB = [
  { en: "ï½ as well", ja: "ï½ã‚‚ã¾ãŸ" },
  { en: "a good deal (of ï½)", ja: "ã‹ãªã‚Šå¤šãï¼ˆã®ï½ï¼‰" },
  { en: "a good many ï½", ja: "ï¼ˆã‹ãªã‚Šï¼‰å¤šãã®ï½" },
  { en: "a great deal (of ï½)", ja: "éå¸¸ã«å¤šãï¼ˆã®ï½ï¼‰" },
  { en: "a great many ï½", ja: "ï¼ˆéå¸¸ã«ï¼‰å¤šãã®ï½" },
  { en: "a great number of ï½", ja: "ãŸãã•ã‚“ã®ï½" },
  { en: "a large number of ï½", ja: "ãŸãã•ã‚“ã®ï½" },
  { en: "a man of few words", ja: "å£æ•°ã®å°‘ãªã„äºº" },
  { en: "a man of his word", ja: "ç´„æŸã‚’å®ˆã‚‹äºº" },
  { en: "a man of sense", ja: "è‰¯è­˜ã®ã‚ã‚‹äºº" },
  { en: "a number of ï½", ja: "ãŸãã•ã‚“ã®ï½ï¼›ã„ãã‚‰ã‹ã®ï½" },
  { en: "a small number of ï½", ja: "å°‘ã—ã®ï½" },
  { en: "abide by ï½", ja: "ï½ã‚’å®ˆã‚‹ï¼Œï½ã«å¾“ã†" },
];

/* =========================
   ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
========================= */
const $ = (id) => document.getElementById(id);
const LS = {
  get(key, fallback){
    try{
      const v = localStorage.getItem(key);
      return v === null ? fallback : JSON.parse(v);
    }catch(e){
      return fallback;
    }
  },
  set(key, value){
    try{ localStorage.setItem(key, JSON.stringify(value)); }catch(e){}
  }
};
function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

/* =========================
   è¦ç´ 
========================= */
const pageTitle = $("pageTitle");
const progressEl = $("progress");
const wordTextEl = $("wordText");
const meaningEl = $("meaning");
const wordNumHeader = $("wordNumHeader");

const nextBtn = $("nextBtn");
const resetBtn = $("resetBtn");
const clearWrongBtn = $("clearWrongBtn");

const wrongOnlyToggle = $("wrongOnlyToggle");
const wrongCount = $("wrongCount");

const missBox = $("missBox");
const missToggle = $("missToggle");

const autoBtn = $("autoBtn");
const audioToggle = $("audioToggle");
const themeToggle = $("themeToggle");
const orderToggle = $("orderToggle");

const rangeFrom = $("rangeFrom");
const rangeTo = $("rangeTo");

const wheelOpenBtn = $("wheelOpenBtn");
const speakBtn = $("speakBtn");

/* é€Ÿåº¦UI */
const rateRange = $("rateRange");
const rateLabel = $("rateLabel");

/* âœ… Autoè¡¨ç¤ºæ™‚é–“UI */
const autoEnMsInput = $("autoEnMs");
const autoJaMsInput = $("autoJaMs");
const autoTimeResetBtn = $("autoTimeResetBtn");

/* Wake lock UI */
const wakeBadge = $("wakeBadge");
const wakeDot = $("wakeDot");
const wakeText = $("wakeText");

/* wheel modal */
const wheelOverlay = $("wheelOverlay");
const wheelCloseBtn = $("wheelCloseBtn");
const wheelSearchInput = $("wheelSearchInput");
const wheelClearSearchBtn = $("wheelClearSearchBtn");
const wheelList = $("wheelList");
const wheelViewport = $("wheelViewport");
const wheelMoreBtn = $("wheelMoreBtn");
const wheelJumpBtn = $("wheelJumpBtn");
const wheelHint = $("wheelHint");

/* =========================
   çŠ¶æ…‹ï¼ˆphaseæ–¹å¼ï¼‰
========================= */
const APP_KEY = "ei_idiom_state_v3";

const state = {
  idx: 0,
  orderRandom: true,
  audioOn: true,
  dark: false,
  wrongSet: {},

  rangeFrom: 1,
  rangeTo: Math.min(10, VOCAB.length),
  shuffled: [],
  wrongOnly: false,

  rate: 1.0,

  started: false,
  phase: 0,     // 0:å‡ºé¡Œ  1:ç­”ãˆ

  autoOn: false, // âœ… Autoé‹è»¢ä¸­ã‹

  /* âœ… Autoè¡¨ç¤ºæ™‚é–“ï¼ˆmsï¼‰ */
  autoEnMs: 1000,
  autoJaMs: 1500,
};

function loadState(){
  const saved = LS.get(APP_KEY, null);
  if(!saved) return;

  if(typeof saved.idx === "number") state.idx = saved.idx;
  if(typeof saved.orderRandom === "boolean") state.orderRandom = saved.orderRandom;
  if(typeof saved.audioOn === "boolean") state.audioOn = saved.audioOn;
  if(typeof saved.dark === "boolean") state.dark = saved.dark;
  if(saved.wrongSet && typeof saved.wrongSet === "object") state.wrongSet = saved.wrongSet;
  if(typeof saved.rangeFrom === "number") state.rangeFrom = saved.rangeFrom;
  if(typeof saved.rangeTo === "number") state.rangeTo = saved.rangeTo;
  if(Array.isArray(saved.shuffled)) state.shuffled = saved.shuffled;
  if(typeof saved.wrongOnly === "boolean") state.wrongOnly = saved.wrongOnly;
  if(typeof saved.rate === "number") state.rate = saved.rate;

  if(typeof saved.started === "boolean") state.started = saved.started;
  if(typeof saved.phase === "number") state.phase = saved.phase;

  if(typeof saved.autoOn === "boolean") state.autoOn = saved.autoOn;

  if(typeof saved.autoEnMs === "number") state.autoEnMs = saved.autoEnMs;
  if(typeof saved.autoJaMs === "number") state.autoJaMs = saved.autoJaMs;
}
function saveState(){ LS.set(APP_KEY, state); }

function inRangeIndices(){
  const a = clamp((state.rangeFrom|0), 1, VOCAB.length);
  const b = clamp((state.rangeTo|0), 1, VOCAB.length);
  const lo = Math.min(a,b);
  const hi = Math.max(a,b);
  const arr = [];
  for(let i=lo-1;i<=hi-1;i++) arr.push(i);
  return arr;
}
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}
function buildOrder(){
  const base = inRangeIndices();

  let pool = base;
  if(state.wrongOnly){
    pool = base.filter(i => state.wrongSet[i]);
  }

  if(pool.length === 0){
    state.shuffled = [];
    state.idx = 0;
    return;
  }

  state.shuffled = state.orderRandom ? shuffle(pool) : pool;
  state.idx = 0;
}
function currentRealIndex(){
  if(state.shuffled.length === 0) return null;
  return state.shuffled[clamp(state.idx, 0, state.shuffled.length-1)];
}

/* =========================
   ç™ºéŸ³ï¼ˆé€Ÿåº¦å¯¾å¿œï¼‰
========================= */
function speak(text){
  if(!state.audioOn) return;
  if(!("speechSynthesis" in window)) return;

  try{ window.speechSynthesis.cancel(); }catch(e){}
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "en-US";
  u.rate = clamp(Number(state.rate) || 1.0, 0.1, 10);
  window.speechSynthesis.speak(u);
}
function speakCurrent(){
  const real = currentRealIndex();
  if(real === null) return;
  speak(VOCAB[real].en);
}

/* =========================
   âœ… Wake Lockï¼ˆã‚¹ãƒªãƒ¼ãƒ—å¯¾ç­–ï¼‰
========================= */
let wakeLockSentinel = null;
let wakeKeepAliveTimer = 0;

function setWakeUI(on, reason){
  wakeBadge.classList.toggle("show", !!state.autoOn);
  wakeDot.classList.toggle("on", !!on);
  wakeDot.classList.toggle("off", !on);
  wakeText.textContent = on ? "Wake: ON" : "Wake: OFF";
  if(reason && state.autoOn){
    wakeBadge.title = reason;
  }
}

async function requestWakeLock(){
  setWakeUI(false, "WakeLockã‚’å–å¾—ä¸­â€¦");

  try{
    if("wakeLock" in navigator && navigator.wakeLock && navigator.wakeLock.request){
      wakeLockSentinel = await navigator.wakeLock.request("screen");
      setWakeUI(true, "WakeLock: Screen Wake Lock APIã§ç¶­æŒä¸­");

      wakeLockSentinel.addEventListener("release", () => {
        wakeLockSentinel = null;
        if(state.autoOn && document.visibilityState === "visible"){
          requestWakeLock().catch(()=>{});
        }else{
          setWakeUI(false, "WakeLock: OFF");
        }
      });

      return;
    }
  }catch(e){
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¸
  }

  clearInterval(wakeKeepAliveTimer);
  wakeKeepAliveTimer = setInterval(() => { void Date.now(); }, 25_000);

  setWakeUI(false, "ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯WakeLockéå¯¾å¿œã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼ˆiPhone Safariç­‰ï¼‰ã€‚Autoä¸­ã¯æ™‚ã€…ç”»é¢ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ç¶­æŒã—ã‚„ã™ã„ã§ã™ã€‚");
}

async function releaseWakeLock(){
  try{
    if(wakeLockSentinel){
      await wakeLockSentinel.release();
    }
  }catch(e){}
  wakeLockSentinel = null;

  if(wakeKeepAliveTimer){
    clearInterval(wakeKeepAliveTimer);
    wakeKeepAliveTimer = 0;
  }
  setWakeUI(false, "WakeLock: OFF");
}

document.addEventListener("visibilitychange", () => {
  if(!state.autoOn) return;
  if(document.visibilityState === "visible"){
    requestWakeLock().catch(()=>{});
  }
});

/* =========================
   UIæ›´æ–°
========================= */
function updateAutoBtn(){
  autoBtn.textContent = state.autoOn ? "â¸ Auto" : "â–¶ï¸ Auto";
}

function updateTopUI(){
  const total = state.shuffled.length;

  if(!state.started){
    progressEl.textContent = `0 / ${total}`;
  }else{
    const cur = total ? (state.idx + 1) : 0;
    progressEl.textContent = `${cur} / ${total}`;
  }

  const real = currentRealIndex();
  wordNumHeader.textContent = (!state.started || real === null) ? "" : String(real + 1);

  rangeFrom.value = String(state.rangeFrom);
  rangeTo.value = String(state.rangeTo);

  wrongOnlyToggle.checked = !!state.wrongOnly;
  orderToggle.textContent = state.orderRandom ? "ğŸ”€" : "ğŸ”¢";
  audioToggle.textContent = state.audioOn ? "ğŸ”Š" : "ğŸ”‡";
  themeToggle.textContent = state.dark ? "ğŸŒ™" : "â˜€ï¸";

  const base = inRangeIndices();
  const cnt = base.filter(i => state.wrongSet[i]).length;
  wrongCount.textContent = `(${cnt})`;

  rateRange.value = String(state.rate);
  rateLabel.textContent = `${state.rate.toFixed(1)}x`;

  // âœ… Autoæ™‚é–“UI
  autoEnMsInput.value = String(state.autoEnMs);
  autoJaMsInput.value = String(state.autoJaMs);

  updateAutoBtn();
}

function render(){
  pageTitle.textContent = document.title;

  const real = currentRealIndex();
  updateTopUI();

  if(real !== null){
    missToggle.checked = !!state.wrongSet[real];
  }

  if(real === null){
    wordTextEl.textContent = "ãƒªã‚¹ãƒˆãŒç©ºã§ã™";
    meaningEl.textContent = "ç¯„å›²ã‚’åºƒã’ã‚‹ã‹ã€ã€Œå¾©ç¿’ã€ã‚’OFFã«ã™ã‚‹ã‹ã€å¾©ç¿’ãƒªã‚¹ãƒˆã‚’ç™»éŒ²ã—ã¦ã­";
    nextBtn.textContent = "ã¯ã˜ã‚ã‚‹";
    state.started = false;
    state.phase = 0;
    missBox.classList.remove("show");
    missToggle.checked = false;
    saveState();
    return;
  }

  if(!state.started){
    wordTextEl.textContent = "Ready Steady GO!";
    meaningEl.textContent = "";
    nextBtn.textContent = "ã¯ã˜ã‚ã‚‹";
    missBox.classList.remove("show");
    missToggle.checked = false;
    saveState();
    return;
  }

  const item = VOCAB[real];
  wordTextEl.textContent = item.en;

  if(state.phase === 0){
    meaningEl.textContent = "";
    nextBtn.textContent = "æ—¥æœ¬èªè¨³ã‚’ç¢ºèªï¼ˆç­”ãˆåˆã‚ã›ï¼‰";
    missBox.classList.remove("show");
  }else{
    meaningEl.textContent = item.ja;
    nextBtn.textContent = "æ­£è§£ã ã£ãŸã‹ãªï¼Ÿ æ¬¡ã®å˜èªã¸ï¼";
    missBox.classList.add("show");
    missToggle.checked = !!state.wrongSet[real];
  }

  saveState();
}

/* =========================
   æ“ä½œï¼ˆ2æ®µéšï¼‰
========================= */
function stopAuto(){
  state.autoOn = false;
  if(autoTimer) clearTimeout(autoTimer);
  autoTimer = 0;
  updateAutoBtn();
  saveState();
  releaseWakeLock().catch(()=>{});
}

function startOrAdvance(){
  stopAuto(); // âœ… æ‰‹å‹•æ“ä½œã§Autoåœæ­¢

  const real = currentRealIndex();
  if(real === null) { render(); return; }

  if(!state.started){
    state.started = true;
    state.phase = 0;
    render();
    speakCurrent();
    return;
  }

  if(state.phase === 0){
    state.phase = 1;
    render();
    return;
  }

  if(state.idx >= state.shuffled.length - 1){
    state.idx = 0;
  }else{
    state.idx++;
  }
  state.phase = 0;
  render();
  speakCurrent();
}

function hardReset(){
  stopAuto();
  state.idx = 0;
  state.started = false;
  state.phase = 0;
  buildOrder();
  render();
}

function clearWrong(){
  stopAuto();
  state.wrongSet = {};
  buildOrder();
  state.idx = 0;
  state.started = false;
  state.phase = 0;
  render();
}

function applyFromInput(){
  stopAuto();

  let from = Number(rangeFrom.value || 1);
  let to   = Number(rangeTo.value   || 1);

  from = clamp(from, 1, VOCAB.length);

  // âœ… ã€‡ã¯ â–¡ ã‚’è¶…ãˆã‚‰ã‚Œãªã„
  if(from > to) from = to;

  state.rangeFrom = from;
  rangeFrom.value = String(from);

  buildOrder();
  state.idx = 0;
  state.started = false;
  state.phase = 0;
  render();
}

function applyToInput(){
  stopAuto();

  let from = Number(rangeFrom.value || 1);
  let to   = Number(rangeTo.value   || 1);

  to = clamp(to, 1, VOCAB.length);

  // âœ… â–¡ ã¯ ã€‡ æœªæº€ã«ã§ããªã„
  if(to < from) to = from;

  state.rangeTo = to;
  rangeTo.value = String(to);

  buildOrder();
  state.idx = 0;
  state.started = false;
  state.phase = 0;
  render();
}



/* =========================
   âœ… Autoé‹è»¢ï¼ˆè¡¨ç¤ºæ™‚é–“ã‚’UIã§å¤‰æ›´ï¼‰
========================= */
let autoTimer = 0;

function scheduleAuto(ms){
  if(autoTimer) clearTimeout(autoTimer);
  autoTimer = setTimeout(autoTick, ms);
}

function startAuto(){
  const real = currentRealIndex();
  if(real === null) return;

  state.autoOn = true;
  updateAutoBtn();
  saveState();

  requestWakeLock().catch(()=>{});
  setWakeUI(!!wakeLockSentinel, wakeBadge.title);

  autoTick();
}

function autoTick(){
  if(!state.autoOn) return;

  const real = currentRealIndex();
  if(real === null){
    stopAuto();
    render();
    return;
  }

  // æœªé–‹å§‹ãªã‚‰é–‹å§‹ï¼ˆè‹±èªè¡¨ç¤ºï¼‰â†’è‹±ã®æ™‚é–“å¾…ã¤
  if(!state.started){
    state.started = true;
    state.phase = 0;
    render();
    speakCurrent();
    scheduleAuto(state.autoEnMs);
    return;
  }

  // è‹±èª â†’ å’Œè¨³ï¼ˆå’Œã®æ™‚é–“å¾…ã¤ï¼‰
  if(state.phase === 0){
    state.phase = 1;
    render();
    scheduleAuto(state.autoJaMs);
    return;
  }

  // å’Œè¨³ â†’ æ¬¡ã®è‹±èªï¼ˆè‹±ã®æ™‚é–“å¾…ã¤ï¼‰
  if(state.idx >= state.shuffled.length - 1){
    state.idx = 0;
  }else{
    state.idx++;
  }
  state.phase = 0;
  render();
  speakCurrent();
  scheduleAuto(state.autoEnMs);
}

/* =========================
   âœ… Autoæ™‚é–“UIå‡¦ç†
========================= */
function sanitizeMs(v, min, max, fallback){
  const n = Number(v);
  if(!Number.isFinite(n)) return fallback;
  return clamp(Math.round(n), min, max);
}

autoEnMsInput.addEventListener("change", () => {
  stopAuto();
  state.autoEnMs = sanitizeMs(autoEnMsInput.value, 200, 10000, 1000);
  autoEnMsInput.value = String(state.autoEnMs);
  saveState();
});

autoJaMsInput.addEventListener("change", () => {
  stopAuto();
  state.autoJaMs = sanitizeMs(autoJaMsInput.value, 200, 20000, 1500);
  autoJaMsInput.value = String(state.autoJaMs);
  saveState();
});

autoTimeResetBtn.addEventListener("click", () => {
  stopAuto();
  state.autoEnMs = 1000;
  state.autoJaMs = 1500;
  autoEnMsInput.value = String(state.autoEnMs);
  autoJaMsInput.value = String(state.autoJaMs);
  saveState();
});

/* =========================
   Wheelï¼ˆæ¤œç´¢ï¼‰
========================= */
let wheelFiltered = [];
let wheelShown = 0;
let wheelActiveIndex = 0;
const WHEEL_BATCH = 9999;
let wheelSnapTimer = 0;

function wheelMatch(q, item){
  if(!q) return true;
  const s = q.toLowerCase();
  return (item.en || "").toLowerCase().includes(s) || (item.ja || "").toLowerCase().includes(s);
}
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#39;");
}
function updateWheelHint(){
  const total = wheelFiltered.length;
  wheelHint.textContent = (total === 0) ? "è©²å½“ãªã—" : `${total}ä»¶ / è¡¨ç¤º ${wheelShown}ä»¶`;
  wheelMoreBtn.style.display = (wheelShown >= wheelFiltered.length) ? "none" : "";
}
function wheelUpdateActiveClass(){
  const items = wheelList.querySelectorAll(".wheelItem");
  items.forEach((li, idx) => li.classList.toggle("isActive", idx === wheelActiveIndex));
}
function wheelScrollToIndex(i, smooth){
  const items = wheelList.querySelectorAll(".wheelItem");
  if(!items.length) return;

  const idx = clamp(i, 0, items.length - 1);
  const target = items[idx];

  const top = target.offsetTop + (target.offsetHeight / 2) - (wheelViewport.clientHeight / 2);
  wheelViewport.scrollTo({ top, behavior: smooth ? "smooth" : "auto" });

  wheelActiveIndex = idx;
  wheelUpdateActiveClass();
}
function wheelPickNearest(){
  const items = wheelList.querySelectorAll(".wheelItem");
  if(!items.length) return 0;

  const centerY = wheelViewport.scrollTop + wheelViewport.clientHeight / 2;

  let best = 0;
  let bestDist = Infinity;
  items.forEach((el, i) => {
    const y = el.offsetTop + el.offsetHeight / 2;
    const d = Math.abs(y - centerY);
    if(d < bestDist){
      bestDist = d;
      best = i;
    }
  });
  return best;
}
function wheelSnap(){
  const i = wheelPickNearest();
  wheelScrollToIndex(i, true);
}
function renderWheelItems(){
  wheelList.innerHTML = "";
  const slice = wheelFiltered.slice(0, wheelShown);

  slice.forEach((v, idx) => {
    const li = document.createElement("li");
    li.className = "wheelItem";
    li.dataset.index = String(idx);
    li.innerHTML = `
      <div class="wheelItemInner">
        <div class="num">${v.i + 1}</div>
        <div>
          <div class="main">${escapeHtml(v.en)}</div>
          <span class="ja">${escapeHtml(v.ja)}</span>
        </div>
      </div>
    `;
    wheelList.appendChild(li);
  });

  wheelActiveIndex = clamp(wheelActiveIndex, 0, Math.max(0, slice.length - 1));
  wheelUpdateActiveClass();
}
function rebuildWheelList(){
  const q = (wheelSearchInput.value || "").trim();
  wheelFiltered = VOCAB.map((v, i) => ({...v, i})).filter(v => wheelMatch(q, v));
  wheelShown = wheelFiltered.length;
  wheelActiveIndex = 0;
  renderWheelItems();
  updateWheelHint();
  wheelViewport.scrollTop = 0;
  requestAnimationFrame(() => {
    wheelActiveIndex = 0;
    wheelScrollToIndex(0, false);
  });
}
function openWheel(){
  stopAuto();
  wheelOverlay.classList.add("show");
  wheelOverlay.setAttribute("aria-hidden", "false");
  wheelSearchInput.value = "";
  wheelShown = 0;
  wheelActiveIndex = 0;
  rebuildWheelList();
  setTimeout(()=>wheelSearchInput.focus(), 50);
}
function closeWheel(){
  wheelOverlay.classList.remove("show");
  wheelOverlay.setAttribute("aria-hidden", "true");
}
function wheelMore(){
  wheelShown = Math.min(wheelShown + WHEEL_BATCH, wheelFiltered.length);
  renderWheelItems();
  updateWheelHint();
}
function wheelJumpToSelected(){
  stopAuto();

  if(wheelFiltered.length === 0) return;
  const picked = wheelFiltered[wheelActiveIndex];
  if(!picked) return;

  const pos = state.shuffled.indexOf(picked.i);
  if(pos >= 0){
    state.idx = pos;
  }else{
    state.wrongOnly = false;
    wrongOnlyToggle.checked = false;
    buildOrder();
    const pos2 = state.shuffled.indexOf(picked.i);
    state.idx = Math.max(0, pos2);
  }

  state.started = true;
  state.phase = 0;
  render();
  closeWheel();
}

/* =========================
   ã‚¤ãƒ™ãƒ³ãƒˆ
========================= */
nextBtn.addEventListener("click", startOrAdvance);

resetBtn.addEventListener("click", hardReset);
clearWrongBtn.addEventListener("click", clearWrong);

autoBtn.addEventListener("click", () => {
  if(state.autoOn) stopAuto();
  else startAuto();
});

wrongOnlyToggle.addEventListener("change", () => {
  stopAuto();
  state.wrongOnly = wrongOnlyToggle.checked;
  buildOrder();
  state.idx = 0;
  state.started = false;
  state.phase = 0;
  render();
});

missToggle.addEventListener("change", () => {
  const real = currentRealIndex();
  if(real === null) return;

  if(missToggle.checked) state.wrongSet[real] = true;
  else delete state.wrongSet[real];

  updateTopUI();
  saveState();
});

audioToggle.addEventListener("click", () => {
  stopAuto();
  state.audioOn = !state.audioOn;
  if(!state.audioOn){
    try{ window.speechSynthesis.cancel(); }catch(e){}
  }
  render();
});

themeToggle.addEventListener("click", () => {
  stopAuto();
  state.dark = !state.dark;
  document.body.classList.toggle("dark", state.dark);
  render();
});

orderToggle.addEventListener("click", () => {
  stopAuto();
  state.orderRandom = !state.orderRandom;
  buildOrder();
  state.idx = 0;
  state.started = false;
  state.phase = 0;
  render();
});

// ======== ã‚¤ãƒ™ãƒ³ãƒˆ ========
rangeFrom.addEventListener("change", applyFromInput);
rangeTo.addEventListener("change", applyToInput);

rateRange.addEventListener("input", () => {
  state.rate = Number(rateRange.value);
  rateLabel.textContent = `${state.rate.toFixed(1)}x`;
  saveState();
});

// ç™ºéŸ³ãƒœã‚¿ãƒ³ï¼ˆã„ã¤ã§ã‚‚OKï¼‰
speakBtn.addEventListener("click", () => {
  stopAuto();
  const real = currentRealIndex();
  if(real === null) return;
  speak(VOCAB[real].en);
});

// wheel
wheelOpenBtn.addEventListener("click", openWheel);
wheelCloseBtn.addEventListener("click", closeWheel);
wheelClearSearchBtn.addEventListener("click", () => { wheelSearchInput.value = ""; rebuildWheelList(); });
wheelSearchInput.addEventListener("input", rebuildWheelList);
wheelMoreBtn.addEventListener("click", wheelMore);
wheelJumpBtn.addEventListener("click", wheelJumpToSelected);

wheelList.addEventListener("click", (e) => {
  const li = e.target.closest(".wheelItem");
  if(!li) return;
  const idx = parseInt(li.dataset.index || "0", 10);
  if(!Number.isFinite(idx)) return;
  wheelScrollToIndex(idx, true);
});
wheelViewport.addEventListener("scroll", () => {
  clearTimeout(wheelSnapTimer);
  wheelSnapTimer = setTimeout(() => {
    if (wheelOverlay.classList.contains("show")) wheelSnap();
  }, 140);
}, { passive: true });

wheelOverlay.addEventListener("click", (e) => { if(e.target === wheelOverlay) closeWheel(); });
document.addEventListener("keydown", (e) => { if(e.key === "Escape" && wheelOverlay.classList.contains("show")) closeWheel(); });

/* =========================
   åˆæœŸåŒ–
========================= */
(function init(){
  rangeTo.max = String(VOCAB.length);
  rangeFrom.max = String(VOCAB.length);

  loadState();

  state.rangeFrom = clamp(state.rangeFrom, 1, VOCAB.length);
  state.rangeTo   = clamp(state.rangeTo,   1, VOCAB.length);

  document.body.classList.toggle("dark", state.dark);

  state.rate = clamp(Number(state.rate) || 1.0, 0.6, 1.4);
  rateRange.value = String(state.rate);
  rateLabel.textContent = `${state.rate.toFixed(1)}x`;

  // âœ… Autoæ™‚é–“ã®è£œæ­£
  state.autoEnMs = clamp(Number(state.autoEnMs) || 1000, 200, 10000);
  state.autoJaMs = clamp(Number(state.autoJaMs) || 1500, 200, 20000);

  if(!Array.isArray(state.shuffled) || state.shuffled.length === 0){
    buildOrder();
  }else{
    const base = new Set(inRangeIndices());
    const ok = state.shuffled.every(i => base.has(i));
    if(!ok) buildOrder();
    state.idx = clamp(state.idx, 0, state.shuffled.length - 1);
  }

  // âœ… å†èª­ã¿è¾¼ã¿ã§å‹æ‰‹ã«Autoé–‹å§‹ã—ãªã„ï¼ˆå®‰å…¨ï¼‰
  state.autoOn = false;
  if(autoTimer) clearTimeout(autoTimer);
  autoTimer = 0;
  updateAutoBtn();
  setWakeUI(false, "WakeLock: OFF");

  rangeFrom.max = String(state.rangeTo);
  rangeTo.min   = String(state.rangeFrom);

  render();
})();
</script>
</body>
</html>
