<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç†Ÿèªãƒ†ã‚¹ãƒˆï¼ˆé‡è¤‡ãªã—ãƒ©ãƒ³ãƒ€ãƒ ï¼‰</title>

  <style>
    /* =========================================================
       åŸºæœ¬ï¼ˆãƒ©ã‚¤ãƒˆï¼‰
     ========================================================= */
    body {
      font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
      margin: 0;
      padding: 20px;
      background: #ffffff;
      color: #111;
      transition: background .2s ease, color .2s ease;
    }

    .card {
      max-width: 820px;
      margin: 0 auto;
      padding: 18px;
      border: 1px solid #ddd;
      border-radius: 14px;
      background: #fff;
      transition: background .2s ease, border-color .2s ease;
    }

    .top {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }

    .badge {
      font-size: 14px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #ddd;
      background: transparent;
      transition: background .2s ease, border-color .2s ease, color .2s ease;
    }

    .row {
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 10px;
    }

    .phrase {
      font-size: 34px;
      font-weight: 800;
      margin: 18px 0 10px;
      line-height: 1.15;
      word-break: break-word;
    }

    .meaning {
      font-size: 24px;
      margin: 10px 0 0;
      min-height: 36px;
      word-break: break-word;
    }

    .btns {
      display:flex;
      gap:10px;
      margin-top: 16px;
      flex-wrap:wrap;
    }

    button {
      font-size: 18px;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid #ddd;
      background: #fff;
      color: #111;
      cursor: pointer;
      transition: background .2s ease, border-color .2s ease, color .2s ease;
    }
    button:active { transform: translateY(1px); }

    .primary { font-weight: 800; }
    .danger { border-color:#f2c; }
    .toggle { border-color:#88c; }
    .small { font-size: 14px; padding: 10px 12px; border-radius: 12px; }

    /* é–“é•ã„ãƒã‚§ãƒƒã‚¯ï¼ˆç­”ãˆåˆã‚ã›æ™‚ã ã‘è¡¨ç¤ºï¼‰ */
    .missBox {
      display:none;
      margin-top: 12px;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 12px;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      transition: background .2s ease, border-color .2s ease, color .2s ease;
    }
    .missBox.show { display:flex; }
    .missBox input { width: 22px; height: 22px; }
    .missBox .label { font-size: 16px; user-select: none; }

    /* =========================================================
       ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ï¼ˆbodyã« .dark ã‚’ä»˜ã‘ã‚‹ï¼‰
     ========================================================= */
    body.dark {
      background: #0f1115;
      color: #e9e9ea;
    }

    body.dark .card {
      background: #171a21;
      border-color: #2a2f3a;
    }

    body.dark .badge {
      border-color: #2a2f3a;
      background: rgba(255,255,255,0.03);
      color: #d6d6d8;
    }

    body.dark button {
      background: #1f2430;
      border-color: #2a2f3a;
      color: #e9e9ea;
    }

    body.dark button:hover {
      background: #252b3a;
    }

    body.dark .missBox {
      border-color: #2a2f3a;
      background: rgba(255,255,255,0.03);
    }
  </style>
</head>

<body>
  <div class="card">
    <div class="top">
      <div class="badge" id="progress">0 / 0</div>
      <div class="badge" id="mode">ç†Ÿèªï¼šè‹±â†’æ—¥</div>
    </div>

    <!-- ç™ºéŸ³ON/OFF + ãƒ†ãƒ¼ãƒåˆ‡æ›¿ï¼ˆã“ã“ã«è¿½åŠ ï¼‰ -->
    <div class="row">
      <button class="toggle small" id="audioToggle">ğŸ”Š ç™ºéŸ³ï¼šON</button>
      <button class="toggle small" id="themeToggle">ğŸŒ™ ãƒ€ãƒ¼ã‚¯</button>
    </div>

    <!-- å‡ºé¡Œãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ï¼ˆå…¨ / é–“é•ã„ã®ã¿ï¼‰ -->
    <div class="row">
      <label class="badge" style="display:flex; gap:8px; align-items:center;">
        <input type="checkbox" id="wrongOnlyToggle" style="width:18px;height:18px;" />
        é–“é•ã„ãƒªã‚¹ãƒˆã ã‘å‡ºé¡Œ
      </label>
      <div class="badge" id="wrongCount">é–“é•ã„: 0</div>
      <button class="small danger" id="clearWrongBtn" type="button">é–“é•ã„ãƒªã‚¹ãƒˆã‚’æ¶ˆã™</button>
    </div>

    <div class="phrase" id="phrase">ï¼ˆIDIOMSãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­â€¦ï¼‰</div>
    <div class="meaning" id="meaning"></div>

    <!-- â˜…ç­”ãˆåˆã‚ã›è¡¨ç¤ºä¸­ã ã‘å‡ºã‚‹ï¼šé–“é•ãˆãŸãƒã‚§ãƒƒã‚¯ -->
    <div class="missBox" id="missBox">
      <input type="checkbox" id="missToggle" />
      <label class="label" for="missToggle">ã“ã®ç†Ÿèªã¯é–“é•ãˆãŸï¼ˆé–“é•ã„ãƒªã‚¹ãƒˆã«å…¥ã‚Œã‚‹ï¼‰</label>
    </div>

    <!-- æ¬¡ã¸ / ç™ºéŸ³ / ãƒªã‚»ãƒƒãƒˆ -->
    <div class="btns">
      <button class="primary" id="nextBtn">ã¯ã˜ã‚ã‚‹</button>
      <button id="speakBtn">ğŸ”Š ç™ºéŸ³</button>
      <button id="resetBtn" class="danger">ãƒªã‚»ãƒƒãƒˆï¼ˆæœ€åˆã‹ã‚‰ï¼‰</button>
    </div>
  </div>

<script>
const VOCAB = [
  { en: "ï½ as well", ja: "ï½ã‚‚ã¾ãŸ" },
  { en: "a good deal (of ï½)", ja: "ã‹ãªã‚Šå¤šãï¼ˆã®ï½ï¼‰" },
  { en: "a good many ï½", ja: "ï¼ˆã‹ãªã‚Šï¼‰å¤šãã®ï½" },
  { en: "a great deal (of ï½)", ja: "éå¸¸ã«å¤šãï¼ˆã®ï½ï¼‰" },
];



// =======================
//  ä¿å­˜ã‚­ãƒ¼ï¼ˆè¿½åŠ åˆ†è¾¼ã¿ï¼‰
// =======================
const KEY_AUDIO       = "idioms_app_audio_on_v1";

// å…¨ãƒ¢ãƒ¼ãƒ‰/é–“é•ã„ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ¥ã§é€²è¡Œä¿å­˜
const KEY_STATE_ALL   = "idioms_state_all_v1";
const KEY_STATE_WRONG = "idioms_state_wrong_v1";

// é–“é•ã„ã‚»ãƒƒãƒˆï¼ˆenæ–‡å­—åˆ—ã§ç®¡ç†ï¼‰
const KEY_WRONG_SET   = "idioms_wrong_set_v1";

// é–“é•ã„ã®ã¿ãƒ¢ãƒ¼ãƒ‰ON/OFF
const KEY_WRONG_ONLY  = "idioms_wrong_only_v1";

// â˜…ãƒ†ãƒ¼ãƒï¼ˆãƒ©ã‚¤ãƒˆ/ãƒ€ãƒ¼ã‚¯ï¼‰
const KEY_THEME       = "idioms_theme_v1";

// =======================
//  ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// =======================
function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function saveJSON(key, obj) { localStorage.setItem(key, JSON.stringify(obj)); }
function loadJSON(key) {
  try {
    const raw = localStorage.getItem(key);
    return raw ? JSON.parse(raw) : null;
  } catch { return null; }
}

// =======================
//  ãƒ†ãƒ¼ãƒï¼ˆãƒ©ã‚¤ãƒˆ/ãƒ€ãƒ¼ã‚¯ï¼‰
// =======================
function loadTheme() {
  const v = localStorage.getItem(KEY_THEME);
  return (v === "dark" || v === "light") ? v : "light";
}
function saveTheme(theme) {
  localStorage.setItem(KEY_THEME, theme);
}
function applyTheme(theme) {
  const isDark = theme === "dark";
  document.body.classList.toggle("dark", isDark);
  const btn = document.getElementById("themeToggle");
  if (btn) btn.textContent = isDark ? "â˜€ï¸ ãƒ©ã‚¤ãƒˆ" : "ğŸŒ™ ãƒ€ãƒ¼ã‚¯";
}

// =======================
//  ç™ºéŸ³ï¼ˆWeb Speech APIï¼‰
// =======================
function pickEnglishVoice() {
  const voices = speechSynthesis.getVoices();
  const preferred =
    voices.find(v => /Samantha|Karen/i.test(v.name || "")) ||
    voices.find(v => (v.lang || "").toLowerCase().startsWith("en-us")) ||
    voices.find(v => (v.lang || "").toLowerCase().startsWith("en-gb")) ||
    voices.find(v => (v.lang || "").toLowerCase().startsWith("en")) ||
    null;
  return preferred;
}

// "~" ã‚’èª­ã¾ã›ãªã„
function cleanForSpeech(text) {
  return String(text)
    .replaceAll("~", "")
    .replace(/\s+/g, " ")
    .trim();
}

function loadAudioOn() {
  const v = localStorage.getItem(KEY_AUDIO);
  return v === null ? true : v === "1";
}
function saveAudioOn(on) {
  localStorage.setItem(KEY_AUDIO, on ? "1" : "0");
}

function speakEnglish(text) {
  if (!window.speechSynthesis) return;
  if (!loadAudioOn()) return;

  try { speechSynthesis.cancel(); } catch {}
  const u = new SpeechSynthesisUtterance(cleanForSpeech(text));

  const voice = pickEnglishVoice();
  u.lang = voice?.lang || "en-US";
  if (voice) u.voice = voice;
  u.rate = 1.0;
  u.pitch = 1.0;

  speechSynthesis.speak(u);
}

function updateAudioUI() {
  const on = loadAudioOn();
  document.getElementById("audioToggle").textContent = on ? "ğŸ”Š ç™ºéŸ³ï¼šON" : "ğŸ”‡ ç™ºéŸ³ï¼šOFF";
}

// =======================
//  é–“é•ã„ãƒªã‚¹ãƒˆï¼ˆSetï¼‰
// =======================
function loadWrongSet() {
  const arr = loadJSON(KEY_WRONG_SET);
  return new Set(Array.isArray(arr) ? arr : []);
}
function saveWrongSet(set) {
  saveJSON(KEY_WRONG_SET, Array.from(set));
}
function updateWrongCountUI() {
  const set = loadWrongSet();
  document.getElementById("wrongCount").textContent = `é–“é•ã„: ${set.size}`;
}

// =======================
//  å‡ºé¡Œãƒ¢ãƒ¼ãƒ‰ï¼ˆå…¨ / é–“é•ã„ã®ã¿ï¼‰
// =======================
function loadWrongOnly() {
  return localStorage.getItem(KEY_WRONG_ONLY) === "1";
}
function saveWrongOnly(on) {
  localStorage.setItem(KEY_WRONG_ONLY, on ? "1" : "0");
}
function getActiveStateKey() {
  return loadWrongOnly() ? KEY_STATE_WRONG : KEY_STATE_ALL;
}

// å‡ºé¡Œãƒ—ãƒ¼ãƒ«ï¼ˆIDIOMSã®indexé…åˆ—ï¼‰
function getPoolIndices() {
  if (!loadWrongOnly()) {
    return [...Array(IDIOMS.length).keys()];
  }
  const set = loadWrongSet();
  const idxs = [];
  for (let i = 0; i < IDIOMS.length; i++) {
    if (set.has(IDIOMS[i].en)) idxs.push(i);
  }
  return idxs;
}

function freshStateForPool(poolIdxs) {
  const order = shuffle([...Array(poolIdxs.length).keys()]);
  return { poolIdxs, order, index: 0, phase: 0 }; // phase:0è‹± 1æ—¥
}

function loadState() {
  const key = getActiveStateKey();
  const st = loadJSON(key);
  if (!st) return null;
  if (!Array.isArray(st.poolIdxs) || !Array.isArray(st.order)) return null;
  if (typeof st.index !== "number" || typeof st.phase !== "number") return null;
  if (st.phase !== 0 && st.phase !== 1) return null;

  // ãƒ—ãƒ¼ãƒ«ãŒå¤‰åŒ–ã—ãŸã‚‰ä½œã‚Šç›´ã™ï¼ˆé–“é•ã„è¿½åŠ /å‰Šé™¤ã€ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´ãªã©ï¼‰
  const poolNow = getPoolIndices();
  if (st.poolIdxs.length !== poolNow.length) return null;

  return st;
}

function saveState(st) {
  const key = getActiveStateKey();
  saveJSON(key, st);
}

// ç¾åœ¨ã®ç†Ÿèªå–å¾—
function getCurrentItem(st) {
  if (!st.poolIdxs.length) return null;
  const poolIndex = st.poolIdxs[ st.order[st.index] ]; // IDIOMSã®index
  return { item: IDIOMS[poolIndex], idiomIndex: poolIndex };
}

// =======================
//  UI
// =======================
function setUI(st) {
  const phraseEl = document.getElementById("phrase");
  const meaningEl = document.getElementById("meaning");
  const progressEl = document.getElementById("progress");
  const modeEl = document.getElementById("mode");
  const btn = document.getElementById("nextBtn");

  const missBox = document.getElementById("missBox");
  const missToggle = document.getElementById("missToggle");

  modeEl.textContent = loadWrongOnly() ? "ç†Ÿèªï¼šè‹±â†’æ—¥ï¼ˆé–“é•ã„ã®ã¿ï¼‰" : "ç†Ÿèªï¼šè‹±â†’æ—¥";

  // ãƒ—ãƒ¼ãƒ«ãŒç©ºãªã‚‰æ¡ˆå†…
  if (!st.poolIdxs.length) {
    phraseEl.textContent = "é–“é•ã„ãƒªã‚¹ãƒˆãŒç©ºã§ã™";
    meaningEl.textContent = "ã€Œé–“é•ã„ãƒªã‚¹ãƒˆã ã‘å‡ºé¡Œã€ã‚’OFFã«ã™ã‚‹ã‹ã€é–“é•ã„ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚";
    progressEl.textContent = "0 / 0";
    btn.textContent = "ã¯ã˜ã‚ã‚‹";
    missBox.classList.remove("show");
    missToggle.checked = false;
    return;
  }

  // 1å‘¨çµ‚ã‚ã£ãŸã‚‰å†ã‚·ãƒ£ãƒƒãƒ•ãƒ«
  if (st.index >= st.poolIdxs.length) {
    st = freshStateForPool(getPoolIndices());
    saveState(st);
  }

  const cur = getCurrentItem(st);
  const current = cur.item;

  progressEl.textContent = `${st.index + 1} / ${st.poolIdxs.length}`;

  // ã“ã®ç†ŸèªãŒã™ã§ã«é–“é•ã„ãƒªã‚¹ãƒˆã«ã‚ã‚‹ã‹
  const wrongSet = loadWrongSet();
  missToggle.checked = wrongSet.has(current.en);

  if (st.phase === 0) {
    phraseEl.textContent = current.en;
    meaningEl.textContent = "";
    btn.textContent = "æ—¥æœ¬èªã‚’è¡¨ç¤ºï¼ˆç­”ãˆåˆã‚ã›ï¼‰";

    missBox.classList.remove("show");

    // â˜…è‹±èªãŒè¡¨ç¤ºã•ã‚ŒãŸç¬é–“ã«ç™ºéŸ³ï¼ˆONã®ã¨ãï¼‰
    speakEnglish(current.en);

  } else {
    phraseEl.textContent = current.en;
    meaningEl.textContent = current.ja;
    btn.textContent = "æ­£è§£ã ã£ãŸã‹ãªï¼Ÿæ¬¡ã¸GOï¼";

    // â˜…ç­”ãˆåˆã‚ã›ä¸­ã ã‘ãƒã‚§ãƒƒã‚¯æ¬„è¡¨ç¤º
    missBox.classList.add("show");
  }
}

function nextAction() {
  let st = loadState();
  if (!st) {
    const pool = getPoolIndices();
    st = freshStateForPool(pool);
  }

  if (st.phase === 0) {
    st.phase = 1;
  } else {
    st.phase = 0;
    st.index += 1;
  }
  saveState(st);
  setUI(st);
}

function resetAll() {
  try { speechSynthesis.cancel(); } catch {}
  const pool = getPoolIndices();
  const st = freshStateForPool(pool);
  saveState(st);
  setUI(st);
}

// =======================
//  åˆæœŸåŒ–
// =======================
function init() {
  if (!IDIOMS.length) {
    document.getElementById("phrase").textContent = "IDIOMSãŒç©ºã§ã™";
    return;
  }

  // â˜…ãƒ†ãƒ¼ãƒåˆæœŸåŒ–ï¼ˆDOMãŒã‚ã‚‹çŠ¶æ…‹ã§ç¢ºå®Ÿã«åæ˜ ï¼‰
  applyTheme(loadTheme());
  document.getElementById("themeToggle").addEventListener("click", () => {
    const now = loadTheme();
    const next = (now === "dark") ? "light" : "dark";
    saveTheme(next);
    applyTheme(next);
  });

  // voiceèª­ã¿è¾¼ã¿é…å»¶å¯¾ç­–ï¼ˆiOS/Safariï¼‰
  if (window.speechSynthesis) {
    speechSynthesis.onvoiceschanged = () => updateAudioUI();
    setTimeout(updateAudioUI, 200);
    setTimeout(updateAudioUI, 800);
  } else {
    document.getElementById("audioToggle").disabled = true;
    document.getElementById("speakBtn").disabled = true;
  }

  // é–“é•ã„æ•°è¡¨ç¤º
  updateWrongCountUI();

  // é–“é•ã„ã®ã¿ãƒˆã‚°ãƒ«åˆæœŸåŒ–
  const wrongOnlyToggle = document.getElementById("wrongOnlyToggle");
  wrongOnlyToggle.checked = loadWrongOnly();
  wrongOnlyToggle.addEventListener("change", () => {
    saveWrongOnly(wrongOnlyToggle.checked);

    // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ã—ãŸã‚‰ã€ãã®ãƒ¢ãƒ¼ãƒ‰ã§æœ€åˆã‹ã‚‰
    const pool = getPoolIndices();
    const st = freshStateForPool(pool);
    saveState(st);

    updateWrongCountUI();
    setUI(st);
  });

  // é–“é•ã„ãƒã‚§ãƒƒã‚¯ï¼ˆç­”ãˆåˆã‚ã›ä¸­ã«æŠ¼ã™ï¼‰
  document.getElementById("missToggle").addEventListener("change", (e) => {
    const st = loadState();
    if (!st) return;
    const cur = getCurrentItem(st);
    if (!cur) return;

    const set = loadWrongSet();
    if (e.target.checked) set.add(cur.item.en);
    else set.delete(cur.item.en);

    saveWrongSet(set);
    updateWrongCountUI();
  });

  // é–“é•ã„ãƒªã‚¹ãƒˆæ¶ˆå»
  document.getElementById("clearWrongBtn").addEventListener("click", () => {
    saveWrongSet(new Set());
    updateWrongCountUI();

    // é–“é•ã„ã®ã¿ãƒ¢ãƒ¼ãƒ‰ä¸­ãªã‚‰ãƒ—ãƒ¼ãƒ«ãŒç©ºã«ãªã‚‹ã®ã§UIæ›´æ–°
    const pool = getPoolIndices();
    const st = freshStateForPool(pool);
    saveState(st);
    setUI(st);
  });

  // é€²è¡ŒçŠ¶æ…‹ã®åˆæœŸåŒ–
  const pool = getPoolIndices();
  let st = loadState();
  if (!st) st = freshStateForPool(pool);
  saveState(st);
  setUI(st);

  // æ¬¡ã¸ / ãƒªã‚»ãƒƒãƒˆ
  document.getElementById("nextBtn").addEventListener("click", nextAction);
  document.getElementById("resetBtn").addEventListener("click", resetAll);

  // ç™ºéŸ³ãƒœã‚¿ãƒ³
  document.getElementById("speakBtn").addEventListener("click", () => {
    const st2 = loadState();
    if (!st2) return;
    const cur = getCurrentItem(st2);
    if (!cur) return;
    speakEnglish(cur.item.en);
  });

  // ç™ºéŸ³ON/OFFãƒˆã‚°ãƒ«
  document.getElementById("audioToggle").addEventListener("click", () => {
    const on = loadAudioOn();
    saveAudioOn(!on);
    updateAudioUI();

    // ONã«ã—ãŸç¬é–“ã€ä»Šè¡¨ç¤ºä¸­ã®è‹±èªã‚’1å›èª­ã‚€ï¼ˆphase=0ã®æ™‚ã ã‘ï¼‰
    const st2 = loadState();
    if (st2 && st2.phase === 0) {
      const cur = getCurrentItem(st2);
      if (cur) speakEnglish(cur.item.en);
    }
  });
}

init();
</script>
</body>
</html>
