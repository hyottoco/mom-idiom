<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <!-- <meta name="viewport" content="width=device-width,initial-scale=1" /> -->
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />

  <title>å¡¾ãƒãƒ ç†Ÿèª1357</title>

  <style>
    :root{
      --bd: #ddd;
      --bd-dark: #2a2f3a;
      --bg: #fff;
      --fg: #111;
      --muted: #666;
      --card: #fff;
      --card-dark: #171a21;

      --pill-pad-y: 10px;
      --pill-pad-x: 12px;
      --pill-radius: 999px;

      --btn-radius: 12px;

      /* å¾©ç¿’ç³»ã®æ·¡ã„è‰²ï¼ˆçµ±ä¸€ï¼‰ */
      --review-bg: #f3f6fb;
      --review-bd: #cfd8e3;
      --review-fg: #334155;

      --review-bg-hover: #e9eef7;
      --review-accent: #64748b;
    }

    body{
      font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
      margin: 0;
      padding: 20px;
      background: var(--bg);
      color: var(--fg);
      transition: background .2s ease, color .2s ease;
    }

    .card{
      max-width: 820px;
      margin: 0 auto;
      padding: 18px;
      border: 1px solid var(--bd);
      border-radius: 14px;
      background: var(--card);
      transition: background .2s ease, border-color .2s ease;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 10px;
    }

    .badge,
    button.small,
    .pill{
      font-size: 14px;
      line-height: 1;
      padding: var(--pill-pad-y) var(--pill-pad-x);
      border-radius: var(--pill-radius);
      border: 1px solid var(--bd);
      background: transparent;
      color: inherit;
      transition: background .2s ease, border-color .2s ease, color .2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      user-select: none;
      white-space: nowrap;
    }

    .pill{ cursor: pointer; }

    button.small{ cursor: pointer; }
    button.small:active{ transform: translateY(1px); }

    .btns{
      display:flex;
      gap:10px;
      margin-top: 16px;
      flex-wrap:wrap;
    }
    button{
      font-size: 18px;
      padding: 12px 14px;
      border-radius: var(--btn-radius);
      border: 1px solid var(--bd);
      background: #fff;
      color: #111;
      cursor: pointer;
      transition: background .2s ease, border-color .2s ease, color .2s ease;
    }
    button:active{ transform: translateY(1px); }

    /* â˜…ã“ã“ã«è¿½åŠ ï¼ˆç™ºéŸ³ãƒœã‚¿ãƒ³ã ã‘å³å¯„ã›ï¼‰ */
    #speakBtn{
      margin-left: auto;
      margin-right: 4px; /* å¾®èª¿æ•´ */
    }

    .primary{ font-weight: 500; }
    .danger{ border-color:#f2c; }
    .toggle{ border-color:#88c; }

    .pill.togglePill{ border-color:#88c; }

    .pill input[type="checkbox"]{
      width:18px;
      height:18px;
      margin:0;
      accent-color: #88c;
      transform: translateY(0.5px);
    }
    .pill .count{
      opacity: .85;
      font-variant-numeric: tabular-nums;
    }

    /* =========================================================
       å¾©ç¿’ç³»UIï¼ˆæ·¡ã„è‰²ã§çµ±ä¸€ï¼‰
       â˜…é‡è¦ï¼šãƒã‚§ãƒƒã‚¯ON/OFFã§èƒŒæ™¯è‰²ã¯å¤‰ãˆãªã„ï¼ˆç†æƒ³ã©ãŠã‚Šï¼‰
       â˜…å¾©ç¿’é–‹å§‹ / å¾©ç¿’ãƒªã‚¹ãƒˆã«è¿½åŠ  / å¾©ç¿’Reset ã«é©ç”¨
    ========================================================= */
    .reviewUI{
      background: var(--review-bg);
      border-color: var(--review-bd);
      color: var(--review-fg);
      border-radius: 14px;
    }

    /* hover ã¯ â€œãƒã‚¦ã‚¹ãŒã‚ã‚‹ç’°å¢ƒã ã‘â€ */
    @media (hover: hover) and (pointer: fine){
      .reviewUI:hover{ background: var(--review-bg-hover); }
    }
    /* ã‚¿ãƒƒãƒç«¯æœ«ã§ã¯ hover ç„¡åŠ¹ï¼ˆiPhoneã§è‰²ãŒæˆ»ã‚‰ãªã„å¯¾ç­–ï¼‰ */
    @media (hover: none){
      .reviewUI:hover{ background: var(--review-bg); }
    }

    /* â˜…æŠ¼ã—ã¦ã„ã‚‹é–“ã ã‘ã€Œç™½ãã™ã‚‹ã€(å¾©ç¿’Resetç”¨) */
    .pressWhite:active{
      background: #fff;
      border-color: var(--review-bd);
      color: var(--review-fg);
    }

    /* iPhoneã§ã€ŒæŠ¼ã—ãŸã‚ã¨è‰²ãŒæ®‹ã‚‹ã€å¯¾ç­–ï¼ˆsticky hoverå¯¾ç­–ã®ä¿é™ºï¼‰
       pressWhite ã¯ hover ã‚’çµ¶å¯¾ã«å¤‰ãˆãªã„ */
    @media (hover: none){
      .pressWhite:hover{ background: var(--review-bg); }
    }

    button, label, .pill{
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    .reviewUI input[type="checkbox"]{ accent-color: var(--review-accent); }

    .topbar{
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .topbar-right{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    .rangeInput{
      width: 3.5em;
      padding: 6px 8px;
      border: 1px solid var(--bd);
      border-radius: 10px;
      font-size: 14px;
      background: transparent;
      color: inherit;
      text-align: right;
    }

    .rangeStack{
      display:flex;
      align-items: center;
      gap: 10px;
    }

    .word-no{
      font-size: 14px;   /* â† No ã®ã‚µã‚¤ã‚ºã¯ã“ã“ */
      font-weight: 600;
      color: var(--muted);
      line-height: 1;
      user-select: none;
    }

    .word-num-header{
      font-size: 14px;
      font-weight: 600;
      color: var(--muted);
      margin-left: 2px;
      line-height: 1;
      user-select: none;
    }

    .displayArea{ min-height: 140px; }

    .word{
      margin: 18px 0 10px;
      line-height: 1.1;
      word-break: break-word;
    }
    .word-text{
      font-size: 30px;
      font-weight: 400;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    .meaning{
      font-size: 18px;
      margin: 10px 0 0;
      min-height: 40px;
      word-break: break-word;
      overflow-wrap: anywhere;
    }

    .missBox{
      display:none;
      margin-top: 12px;
      padding: 10px 12px;
      border: 1px solid var(--bd);
      border-radius: 12px;
      gap: 10px;
      align-items: center;
      flex-wrap: nowrap;
      width: fit-content;
      max-width: 100%;
      flex: 0 0 auto;
      align-self: flex-start;
      background: rgba(0,0,0,0.02);
    }
    .missBox.show{ display:inline-flex; }
    .missBox input{ width: 22px; height: 22px; margin:0; }
    .missBox .label{ font-size: 16px; user-select: none; white-space: nowrap; display: inline-block;}

    /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
    body.dark{
      background: #0f1115;
      color: #e9e9ea;
    }
    body.dark .card{
      background: var(--card-dark);
      border-color: var(--bd-dark);
    }
    body.dark .badge,
    body.dark button.small,
    body.dark .pill{
      border-color: var(--bd-dark);
      background: rgba(255,255,255,0.03);
      color: #d6d6d8;
    }
    body.dark button{
      background: #1f2430;
      border-color: var(--bd-dark);
      color: #e9e9ea;
    }
    body.dark button:hover{ background: #252b3a; }
    body.dark .missBox{
      border-color: var(--bd-dark);
      background: rgba(255,255,255,0.03);
    }
    body.dark .rangeInput{ border-color: var(--bd-dark); }
    body.dark .word-num-header{ color:#aaa; }

    body.dark .reviewUI{
      background: rgba(255,255,255,0.06);
      border-color: var(--bd-dark);
      color: #e5e7eb;
    }

    /* ãƒ€ãƒ¼ã‚¯æ™‚ã® hoverï¼ˆãƒã‚¦ã‚¹æ™‚ã®ã¿ï¼‰ */
    @media (hover: hover) and (pointer: fine){
      body.dark .reviewUI:hover{
        background: rgba(255,255,255,0.10);
      }
    }
    @media (hover: none){
      body.dark .reviewUI:hover{
        background: rgba(255,255,255,0.06);
      }
    }

    /* ãƒ€ãƒ¼ã‚¯æ™‚ï¼šæŠ¼ã—ã¦ã‚‹é–“ã ã‘å°‘ã—æ˜ã‚‹ãï¼ˆçœŸã£ç™½ã¯çœ©ã—ã„ã®ã§ï¼‰ */
    body.dark .pressWhite:active{
      background: rgba(255,255,255,0.16);
      border-color: var(--bd-dark);
      color: #e5e7eb;
    }

    /* iPhoneã®ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—æ‹¡å¤§ã‚’èµ·ã“ã—ã«ããã™ã‚‹ */
    button, label, input, .pill{
      touch-action: manipulation;
    }

    /* â˜…ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ« */
    .page-title{
      font-size: 16px;
      font-weight: 700;
      margin: 0 0 12px;
      text-align: center;
      letter-spacing: 0.03em;
    }

    /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ */
    body.dark .page-title{
      color: #e9e9ea;
    }
  </style>
</head>

<body>
  <div class="card">

    <h1 id="pageTitle" class="page-title"></h1>

    <div class="topbar">
      <div class="badge" id="progress">0 / 0</div>

      <div class="topbar-right">
        <button id="resetBtn" class="small reviewUI" type="button">Reset</button>

        <!-- â˜…å¾©ç¿’Resetï¼šæ™®æ®µã¯ reviewUI ã®æ·¡è‰²ã€æŠ¼ã—ã¦ã‚‹é–“ã ã‘ç™½(oræ˜ã‚‹ã) -->
        <button class="small reviewUI pressWhite" id="clearWrongBtn" type="button">å¾©ç¿’Reset</button>
      </div>
    </div>

    <div class="row">
      <!-- â˜…å¾©ç¿’é–‹å§‹ï¼šãƒã‚§ãƒƒã‚¯ON/OFFã§èƒŒæ™¯è‰²ã¯å¤‰ãˆãªã„ï¼ˆreviewUIã¯å›ºå®šï¼‰ -->
      <label class="pill togglePill reviewUI" for="wrongOnlyToggle">
        <input type="checkbox" id="wrongOnlyToggle" />
        å¾©ç¿’ <span class="count" id="wrongCount">(0)</span>
      </label>

      <button class="small toggle" id="audioToggle" type="button">ğŸ”Š</button>
      <button class="small toggle" id="themeToggle" type="button">ğŸŒ™</button>

      <!-- â˜…å‡ºé¡Œé †åˆ‡æ›¿ï¼ˆè¡¨ç¤ºã‚‚è¦ªåˆ‡ç‰ˆï¼‰ -->
      <button class="small toggle" id="orderToggle" type="button">ğŸ”€ ãƒ©ãƒ³ãƒ€ãƒ </button>
    </div>

    <div class="row">
      <div class="rangeStack">
        <label class="badge" style="display:flex; gap:8px; align-items:center;">
          No
          <input id="rangeFrom" class="rangeInput" type="number" min="1" value="1">
          ã€œ
          <input id="rangeTo" class="rangeInput" type="number" min="1" value="10">
        </label>
        <span class="word-no">No</span>
        <span id="wordNumHeader" class="word-num-header"></span>
      </div>
    </div>

    <div class="displayArea">
      <div class="word">
        <span class="word-text" id="wordText">ï¼ˆreadingâ€¦ï¼‰</span>
      </div>
      <div class="meaning" id="meaning"></div>
    </div>

    <div class="btns">
      <button class="primary" id="nextBtn" type="button">ã¯ã˜ã‚ã‚‹</button>
    </div>

    <!-- â–¼ç­”ãˆåˆã‚ã›ä¸­ã ã‘å‡ºã‚‹ï¼šå¾©ç¿’ãƒªã‚¹ãƒˆã«è¿½åŠ 
         â˜…ã“ã‚Œã‚‚ reviewUI ã§æ·¡è‰²å›ºå®šï¼ˆãƒã‚§ãƒƒã‚¯ON/OFFã§èƒŒæ™¯è‰²å¤‰åŒ–ãªã—ï¼‰ -->
    <div class="missBox reviewUI" id="missBox">
      <input type="checkbox" id="missToggle">
      <label class="label" for="missToggle">å¾©ç¿’ãƒªã‚¹ãƒˆã«è¿½åŠ </label>
    </div>

    <div class="btns">
      <button id="speakBtn" type="button">ğŸ”Š ç™ºéŸ³</button>
    </div>

  </div>

<script>
const VOCAB = [
  { en: "ï½ as well", ja: "ï½ã‚‚ã¾ãŸ" },
  { en: "a good deal (of ï½)", ja: "ã‹ãªã‚Šå¤šãï¼ˆã®ï½ï¼‰" },
  { en: "a good many ï½", ja: "ï¼ˆã‹ãªã‚Šï¼‰å¤šãã®ï½" },
  { en: "a great deal (of ï½)", ja: "éå¸¸ã«å¤šãï¼ˆã®ï½ï¼‰" },
  { en: "a great many ï½", ja: "ï¼ˆéå¸¸ã«ï¼‰å¤šãã®ï½" },
  { en: "a great number of ï½", ja: "ãŸãã•ã‚“ã®ï½" },
  { en: "a large number of ï½", ja: "ãŸãã•ã‚“ã®ï½" },
  { en: "a man of few words", ja: "å£æ•°ã®å°‘ãªã„äºº" },
  { en: "a man of his word", ja: "ç´„æŸã‚’å®ˆã‚‹äºº" },
  { en: "a man of sense", ja: "è‰¯è­˜ã®ã‚ã‚‹äºº" },
  { en: "a number of ï½", ja: "ãŸãã•ã‚“ã®ï½ï¼›ã„ãã‚‰ã‹ã®ï½" },
  { en: "a small number of ï½", ja: "å°‘ã—ã®ï½" },
  { en: "abide by ï½", ja: "ï½ã‚’å®ˆã‚‹ï¼Œï½ã«å¾“ã†" },
  { en: "abound in ï½", ja: "ï½ï¼ˆå ´æ‰€ï¼‰ã«â€¦ï¼ˆè³‡æºï¼‰ãŒã„ã£ã±ã„ã " },
  { en: "above all", ja: "ã¨ã‚Šã‚ã‘ï¼Œä½•ã‚ˆã‚Šã‚‚ã¾ãš" },
  { en: "above oneâ€™s reach", ja: "ï½ã®åŠ›ã®åŠã°ãªã„ï¼Œï½ã®æ‰‹ã®å±Šã‹ãªã„" },
  { en: "abstain from ï½", ja: "ï½ã‚’é¿ã‘ã‚‹ï¼Œæ§ãˆã‚‹ï¼›ç¦é…’ã™ã‚‹" },
  { en: "accord with ï½", ja: "ï½ã¨ä¸€è‡´ã™ã‚‹" },
  { en: "according to ï½", ja: "ï½ã«ã‚ˆã‚Œã°ï¼›ï½ã«å¿œã˜ã¦" },
  { en: "account for ï½", ja: "ï½ã‚’èª¬æ˜ã™ã‚‹ï¼›ï½ã®åŸå› ã¨ãªã‚‹ï¼›ï½ã®å‰²åˆã‚’å ã‚ã‚‹" },
  { en: "accuse ï½ of â€¦", ja: "ï½ã‚’â€¦ã§éé›£ã™ã‚‹ï¼Œè²¬ã‚ã‚‹" },
  { en: "act on [upon] ï½", ja: "ï½ã«ä½œç”¨ï¼ˆå½±éŸ¿ï¼‰ã™ã‚‹ï¼›ï½ã«åŸºã¥ã„ã¦è¡Œå‹•ã™ã‚‹" },
];

const KEY_AUDIO       = "vocab_app_audio_on_v1";
const KEY_WRONG_SET   = "vocab_wrong_set_v1";
const KEY_WRONG_ONLY  = "vocab_wrong_only_v1";
const KEY_THEME       = "vocab_theme_v1";
const KEY_RANGE       = "vocab_range_v1";

/* â˜…è¿½åŠ ï¼šå‡ºé¡Œé †ãƒ¢ãƒ¼ãƒ‰ï¼ˆrandom / ascï¼‰ */
const KEY_ORDER_MODE  = "vocab_order_mode_v1";

function shuffle(arr){
  for (let i = arr.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}
function saveJSON(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }
function loadJSON(key){
  try{
    const raw = localStorage.getItem(key);
    return raw ? JSON.parse(raw) : null;
  }catch{ return null; }
}
function clamp(n, min, max){
  return Math.max(min, Math.min(max, n));
}

function loadRange(){
  const saved = loadJSON(KEY_RANGE);
  const maxN = VOCAB.length;

  let from = 1;
  let to = Math.min(10, maxN);

  if (saved && typeof saved.from === "number" && typeof saved.to === "number"){
    from = saved.from;
    to = saved.to;
  }

  from = clamp(Math.floor(from), 1, maxN);
  to   = clamp(Math.floor(to),   1, maxN);
  if (from > to) [from, to] = [to, from];

  return { from, to };
}
function saveRange(r){
  saveJSON(KEY_RANGE, r);
}

function loadTheme(){
  const v = localStorage.getItem(KEY_THEME);
  return (v === "dark" || v === "light") ? v : "light";
}
function saveTheme(theme){
  localStorage.setItem(KEY_THEME, theme);
}
function applyTheme(theme){
  const isDark = theme === "dark";
  document.body.classList.toggle("dark", isDark);
  const btn = document.getElementById("themeToggle");
  if (btn) btn.textContent = isDark ? "â˜€ï¸" : "ğŸŒ™";
}

/* â˜…è¿½åŠ ï¼šå‡ºé¡Œé †ãƒ¢ãƒ¼ãƒ‰ */
function loadOrderMode(){
  const v = localStorage.getItem(KEY_ORDER_MODE);
  return (v === "asc" || v === "random") ? v : "random";
}
function saveOrderMode(mode){
  localStorage.setItem(KEY_ORDER_MODE, mode);
}
function updateOrderUI(){
  const mode = loadOrderMode();
  const btn = document.getElementById("orderToggle");
  if (!btn) return;
  btn.textContent = (mode === "random") ? "ğŸ”€" : "ğŸ”¢";
}

function pickEnglishVoice(){
  const voices = speechSynthesis.getVoices();
  const preferred =
    voices.find(v => /Samantha|Karen/i.test(v.name || "")) ||
    voices.find(v => (v.lang || "").toLowerCase().startsWith("en-us")) ||
    voices.find(v => (v.lang || "").toLowerCase().startsWith("en-gb")) ||
    voices.find(v => (v.lang || "").toLowerCase().startsWith("en")) ||
    null;
  return preferred;
}

function loadAudioOn(){
  const v = localStorage.getItem(KEY_AUDIO);
  return v === null ? true : v === "1";
}
function saveAudioOn(on){
  localStorage.setItem(KEY_AUDIO, on ? "1" : "0");
}
function updateAudioUI(){
  const on = loadAudioOn();
  document.getElementById("audioToggle").textContent = on ? "ğŸ”Š" : "ğŸ”‡";
}

function speakEnglish(text){
  if (!window.speechSynthesis) return;
  if (!loadAudioOn()) return;

  try{ speechSynthesis.cancel(); }catch{}
  const u = new SpeechSynthesisUtterance(String(text));
  const voice = pickEnglishVoice();
  u.lang = voice?.lang || "en-US";
  if (voice) u.voice = voice;
  u.rate = 1.0;
  u.pitch = 1.0;
  speechSynthesis.speak(u);
}

function loadWrongSet(){
  const arr = loadJSON(KEY_WRONG_SET);
  return new Set(Array.isArray(arr) ? arr : []);
}
function saveWrongSet(set){
  saveJSON(KEY_WRONG_SET, Array.from(set));
}
function updateWrongCountUI(){
  const set = loadWrongSet();
  document.getElementById("wrongCount").textContent = `:${set.size}`;
}

function loadWrongOnly(){
  return localStorage.getItem(KEY_WRONG_ONLY) === "1";
}
function saveWrongOnly(on){
  localStorage.setItem(KEY_WRONG_ONLY, on ? "1" : "0");
}

function getActiveStateKey(){
  const { from, to } = loadRange();
  const base = loadWrongOnly() ? "wrong" : "all";
  return `vocab_state_${base}_r${from}-${to}_v1`;
}

function getPoolIndices(){
  const { from, to } = loadRange();
  const start = from - 1;
  const end   = to - 1;

  const ranged = [];
  for (let i = start; i <= end; i++){
    if (i >= 0 && i < VOCAB.length) ranged.push(i);
  }

  if (!loadWrongOnly()) return ranged;

  const set = loadWrongSet();
  return ranged.filter(i => set.has(VOCAB[i].en));
}

/* â˜…å·®ã—æ›¿ãˆï¼šrandom / asc ã®åˆ‡æ›¿ã«å¯¾å¿œ */
function freshStateForPool(poolIdxs){
  const mode = loadOrderMode();

  let order = [...Array(poolIdxs.length).keys()];

  if (mode === "random"){
    order = shuffle(order);
  } else {
    // poolIdxs ãŒå°ã•ã„é †ï¼ˆè‹¥ã„ç•ªå·é †ï¼‰ã«ä¸¦ã¶ã‚ˆã†ã«ã™ã‚‹
    order.sort((a, b) => poolIdxs[a] - poolIdxs[b]);
  }

  return { poolIdxs, order, index: 0, phase: 0 };
}

function loadState(){
  const key = getActiveStateKey();
  const st = loadJSON(key);
  if (!st) return null;
  if (!Array.isArray(st.poolIdxs) || !Array.isArray(st.order)) return null;
  if (typeof st.index !== "number" || typeof st.phase !== "number") return null;
  if (st.phase !== 0 && st.phase !== 1) return null;

  const poolNow = getPoolIndices();
  if (st.poolIdxs.length !== poolNow.length) return null;

  return st;
}
function saveState(st){
  const key = getActiveStateKey();
  saveJSON(key, st);
}

function getCurrentItem(st){
  if (!st.poolIdxs.length) return null;
  const poolIndex = st.poolIdxs[ st.order[st.index] ];
  return { item: VOCAB[poolIndex], vocabIndex: poolIndex };
}

function setUI(st){
  const wordNumHeaderEl = document.getElementById("wordNumHeader");
  const wordTextEl = document.getElementById("wordText");
  const meaningEl = document.getElementById("meaning");
  const progressEl = document.getElementById("progress");
  const btn = document.getElementById("nextBtn");

  const missBox = document.getElementById("missBox");
  const missToggle = document.getElementById("missToggle");

  if (!st.poolIdxs.length){
    wordNumHeaderEl.textContent = "";
    wordTextEl.textContent = "ï¼ˆå‡ºé¡ŒãŒã‚ã‚Šã¾ã›ã‚“ï¼‰";
    meaningEl.textContent = "ç¯„å›²ã‚’åºƒã’ã‚‹ã‹ã€ã€Œå¾©ç¿’é–‹å§‹ã€ã‚’OFFã«ã™ã‚‹ã‹ã€å¾©ç¿’ãƒªã‚¹ãƒˆã‚’ç™»éŒ²ã—ã¦ã­";
    progressEl.textContent = "0 / 0";
    btn.textContent = "ã¯ã˜ã‚ã‚‹";
    missBox.classList.remove("show");
    missToggle.checked = false;
    return;
  }

  if (st.index >= st.poolIdxs.length){
    st = freshStateForPool(getPoolIndices());
    saveState(st);
  }

  const cur = getCurrentItem(st);
  const current = cur.item;
  const number = cur.vocabIndex + 1;

  progressEl.textContent = `${st.index + 1} / ${st.poolIdxs.length}`;

  const wrongSet = loadWrongSet();
  missToggle.checked = wrongSet.has(current.en);

  wordNumHeaderEl.textContent = number;
  wordTextEl.textContent = current.en;

  if (st.phase === 0){
    meaningEl.textContent = "";
    btn.textContent = "æ—¥æœ¬èªè¨³ã‚’ç¢ºèª ï¼ˆç­”ãˆåˆã‚ã›ï¼‰";
    missBox.classList.remove("show");
    speakEnglish(current.en);
  } else {
    meaningEl.textContent = current.ja;
    btn.textContent = "æ­£è§£ã ã£ãŸã‹ãªï¼Ÿ æ¬¡ã®å˜èªã¸ï¼";
    missBox.classList.add("show");
  }
}

function nextAction(){
  let st = loadState();
  if (!st){
    const pool = getPoolIndices();
    st = freshStateForPool(pool);
    saveState(st);
    setUI(st);
    return;
  }

  if (st.phase === 0){
    st.phase = 1;
  } else {
    st.phase = 0;
    st.index += 1;
  }
  saveState(st);
  setUI(st);
}

function resetAll(){
  try{ speechSynthesis.cancel(); }catch{}
  const pool = getPoolIndices();
  const st = freshStateForPool(pool);
  saveState(st);
  setUI(st);
}

function init(){

  document.getElementById("pageTitle").textContent = document.title;

  if (!VOCAB.length){
    document.getElementById("wordText").textContent = "VOCABãŒç©ºã§ã™";
    return;
  }

  applyTheme(loadTheme());
  document.getElementById("themeToggle").addEventListener("click", () => {
    const now = loadTheme();
    const next = (now === "dark") ? "light" : "dark";
    saveTheme(next);
    applyTheme(next);
  });

  /* â˜…å‡ºé¡Œé †UIåˆæœŸåŒ– */
  updateOrderUI();

  if (window.speechSynthesis){
    speechSynthesis.onvoiceschanged = () => updateAudioUI();
    setTimeout(updateAudioUI, 200);
    setTimeout(updateAudioUI, 800);
  } else {
    document.getElementById("audioToggle").disabled = true;
    document.getElementById("speakBtn").disabled = true;
  }

  const rangeFromEl = document.getElementById("rangeFrom");
  const rangeToEl   = document.getElementById("rangeTo");
  const r = loadRange();
  rangeFromEl.value = r.from;
  rangeToEl.value   = r.to;

  function onRangeChange(){
    let from = parseInt(rangeFromEl.value, 10);
    let to   = parseInt(rangeToEl.value, 10);
    if (!Number.isFinite(from)) from = 1;
    if (!Number.isFinite(to)) to = VOCAB.length;

    from = clamp(from, 1, VOCAB.length);
    to   = clamp(to,   1, VOCAB.length);
    if (from > to) [from, to] = [to, from];

    rangeFromEl.value = from;
    rangeToEl.value   = to;

    saveRange({ from, to });

    const pool = getPoolIndices();
    const st = freshStateForPool(pool);
    saveState(st);

    updateWrongCountUI();
    setUI(st);
  }

  rangeFromEl.addEventListener("change", onRangeChange);
  rangeToEl.addEventListener("change", onRangeChange);

  updateWrongCountUI();

  const wrongOnlyToggle = document.getElementById("wrongOnlyToggle");
  wrongOnlyToggle.checked = loadWrongOnly();
  wrongOnlyToggle.addEventListener("change", () => {
    saveWrongOnly(wrongOnlyToggle.checked);

    const pool = getPoolIndices();
    const st = freshStateForPool(pool);
    saveState(st);

    updateWrongCountUI();
    setUI(st);
  });

  document.getElementById("missToggle").addEventListener("change", (e) => {
    const st = loadState();
    if (!st) return;
    const cur = getCurrentItem(st);
    if (!cur) return;

    const set = loadWrongSet();
    if (e.target.checked) set.add(cur.item.en);
    else set.delete(cur.item.en);

    saveWrongSet(set);
    updateWrongCountUI();
  });

  document.getElementById("clearWrongBtn").addEventListener("click", () => {
    saveWrongSet(new Set());
    updateWrongCountUI();

    const pool = getPoolIndices();
    const st = freshStateForPool(pool);
    saveState(st);
    setUI(st);
  });

  const pool = getPoolIndices();
  let st = loadState();
  if (!st) st = freshStateForPool(pool);
  saveState(st);
  setUI(st);

  document.getElementById("nextBtn").addEventListener("click", nextAction);
  document.getElementById("resetBtn").addEventListener("click", resetAll);

  document.getElementById("speakBtn").addEventListener("click", () => {
    const st2 = loadState();
    if (!st2) return;
    const cur = getCurrentItem(st2);
    if (!cur) return;
    speakEnglish(cur.item.en);
  });

  document.getElementById("audioToggle").addEventListener("click", () => {
    const on = loadAudioOn();
    saveAudioOn(!on);
    updateAudioUI();

    const st2 = loadState();
    if (st2 && st2.phase === 0){
      const cur = getCurrentItem(st2);
      if (cur) speakEnglish(cur.item.en);
    }
  });

  /* â˜…è¿½åŠ ï¼šå‡ºé¡Œé †åˆ‡æ›¿ï¼ˆã„ã¤ã§ã‚‚åˆ‡æ›¿ã€å¾©ç¿’ãƒªã‚¹ãƒˆã«ã¯å½±éŸ¿ãªã—ï¼‰ */
  document.getElementById("orderToggle").addEventListener("click", () => {
    const now = loadOrderMode();
    const next = (now === "random") ? "asc" : "random";
    saveOrderMode(next);
    updateOrderUI();

    const pool2 = getPoolIndices();
    const st2 = freshStateForPool(pool2);
    saveState(st2);
    setUI(st2);
  });
}

init();
</script>
</body>
</html>
